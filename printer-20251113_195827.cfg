# This file contains pin mappings for the stock 2020 Creality Ender 3
# Pro with the 32-bit Creality 4.2.2 board. To use this config, during
# "make menuconfig" select the STM32F103 with a "28KiB bootloader" and
# serial (on USART1 PA10/PA9) communication.

# It should be noted that newer variations of this printer shipping in
# 2022 may have GD32F103 chips installed and not STM32F103. You may
# have to inspect the mainboard to ascertain which one you have. If it
# is the GD32F103 then please select Disable SWD at startup in the
# "make menuconfig" along with the same settings for STM32F103.

# If you prefer a direct serial connection, in "make menuconfig"
# select "Enable extra low-level configuration options" and select
# serial (on USART3 PB11/PB10), which is broken out on the 10 pin IDC
# cable used for the LCD module as follows:
# 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.

;----------------------------------;
;    ! → invierte la señal         ;
;                                  ;
;    ^ → pull-up interno activado  ;
;__________________________________;
[respond]
##################################################################################################################
#------------MCU-CONFIG------------------------------------------------------------------------------------------#
# 1) MCU principal: placa Creality 4.2.2-------------------------------------------------------------------------#
[mcu]  
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

# 2) MCU secundaria: RP2040 Pico---------------------------
[mcu pico]
serial: /dev/serial0
;;restart_method: command

[delayed_gcode RPIPICO_LED_ON]                                            
initial_duration: 1                                                                                                                                                    
gcode:                                                             
      SET_PIN PIN=rpipico_led VALUE=1.00    
[output_pin rpipico_led] ;Led indicador encendido RPIPICO
pin: pico:gpio25

;Monitor de temperatura, MCU Creality 4.2.2.---------------
[temperature_sensor mcu_Creality_4_2_2]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

;Monitor de temperatura, MCU Raspberry Pico rp2040.--------
[temperature_sensor mcu_pico_rp2040]
sensor_type: temperature_mcu
sensor_mcu: pico
min_temp: 0
max_temp: 100
;-----------------------------------------------------------
[mcu rpi]
serial: /tmp/klipper_host_mcu

;Monitor de temperatura, MCU host: Raspberry Pi 3B.---------
[temperature_sensor mcu_Raspberry_pi_3B] 
sensor_type: temperature_host
min_temp: 10
max_temp: 90
############################################################
[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[save_variables]
filename: ~/printer_data/config/variables.cfg
[respond] #enables"M118" COMANDS para mostrar mensajes
[display_status]
[pause_resume]
# Enable object exclusion
[exclude_object]
#Enable arcs support
[gcode_arcs]
resolution: 0.1

#########-INCLUDE--##########################################################
[include mainsail.cfg]
[include shell_command.cfg]
[include macros.cfg]
[include pause_resume_new.cfg]
[include KAMP_Settings.cfg]
[include sensores-y-servos.cfg]
[include test_velocidad.cfg]
[include tune_PID.cfg]
[include config_backup.cfg]
[include ./MMCS_MAGUZ_MOD/buzzer-beep.cfg]
[include ./MMCS_MAGUZ_MOD/clean_nozzle.cfg]
[include ./MMCS_MAGUZ_MOD/measure_belt_tension.cfg]
[include ./MMCS_MAGUZ_MOD/Mensajes-MSG.cfg]
[include ./MMCS_MAGUZ_MOD/MMCS-klipperScreen/mmcs-klipperscreen-macros.cfg]
[include ./MMCS_MAGUZ_MOD/MMCS_SYSTEM/MMCS-system-manual-stepper.cfg]
[include ./MMCS_MAGUZ_MOD/MMCS_SYSTEM/Servos.cfg]
[include ./MMCS_MAGUZ_MOD/MMCS_SYSTEM/tip-forming.cfg]
[include ./MMCS_MAGUZ_MOD/MMCS_SYSTEM/MMCS_carga.cfg]

##############################################################################
[stepper_x]
step_pin: PC2
dir_pin: PB9
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: 1
position_max: 249 #pendiente cambiar a 248 cuando acomode la carcasa
position_min: -1 #-10
homing_speed: 50

[stepper_y]
step_pin: PB8
dir_pin: PB7
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: -4
position_max: 235
position_min: -5 #-4
homing_speed: 50

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16         #formula para calcular pasos en kliper:pasos por giro*micropasos/pasosen marlin (200*16/80)
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop  #agregar esta linea de codigo para habilitar e sensor inductivo 
#endstop_pin: ^!PA7   #se deshabilito (endstop_pin: ^!PA7), porque ahora el pin (^!PA7) se esta usando en la seccion [probe],pin: ^!PA7
#position_endstop: 0.0
position_max: 250
position_min: -4

#--------Nivelacion de cama y sensor------------------------ 
[probe]
pin: ^!PA7 #(^!PA7 z-endstop pin, movido aca desde la seccion [stepper_z]
x_offset: -38
y_offset:  -4
speed: 5
lift_speed: 30.0
samples: 2
samples_result: median
sample_retract_dist: 2
samples_tolerance: 0.02      ;;antiguo valor (0.09)
samples_tolerance_retries: 3 ;;numero de intentos de repeticiones al fallar un punto.
#z_offset: 2.309
# z_offset = 2.379 CAMA METAL ultimo

[bed_mesh]
speed: 120
horizontal_move_z: 4
mesh_min: 5, 10
mesh_max: 208, 220 #this may need to be calibrated for your individual printer 197, 242
probe_count: 7,7 #this is the number of probing points on X then Y axis
mesh_pps: 2,2
fade_start: 1
fade_end: 10
fade_target: 0
algorithm: bicubic
bicubic_tension: 0.2

[screws_tilt_adjust]
screw1: 67, 206
screw1_name: Back left
screw2: 67, 32
screw2_name: Front left
screw3: 239, 32
screw3_name: Front right
screw4: 239, 206
screw4_name: Back right
screw_thread: CW-M4
horizontal_move_z: 8
speed: 140

#modi
[safe_z_home]
home_xy_position: 117,117
speed: 50 #60
z_hop: 5
z_hop_speed: 15

[extruder] #E0                   
max_extrude_only_distance: 130.0 #120.0
step_pin: PB4
dir_pin: PB3
enable_pin: !PC3
microsteps: 16
rotation_distance: 7.710  # 34.406  #FORMULA: That is 100 steps per mm = full_rotation_steps * microsteps / steps_per_mm = (200*16/100=32) o (32.000).
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 270 #255
min_extrude_temp: 170 ;;agregado 22-10-25
max_extrude_cross_section: 5
pressure_advance: 0.068 #0.036  #0.025 el mejor valor

;MANUAL_STEPPER--controlado por la (Raspberry PICO rp2040)
[manual_stepper mmcs_stepper]
dir_pin: pico:gpio5           #rpi:gpio24 
step_pin: pico:gpio6          #rpi:gpio23
enable_pin: !pico:gpio7       #!rpi:gpio5
microsteps: 32
rotation_distance: 33.6 #32.0  ;esta configuracion varia en manuel_estepper es el doble.
accel: 1000               ; opcional, suaviza
velocity: 20              ; límite de velocidad minima (mm/s).
#----------------------------------------------------------------------------------

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
#control: pid
# tuned for stock hardware with 50 degree Celsius target
#pid_Kp: 54.027
#pid_Ki: 0.770
#pid_Kd: 948.182
min_temp: 0
max_temp: 130

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 10000
max_z_velocity: 15 #20 #defaul 15
max_z_accel: 100

[display]
lcd_type: st7920
cs_pin: PB12
sclk_pin: PB13
sid_pin: PB15
encoder_pins: ^PB14, ^PB10
click_pin: ^!PB2

;ventiladores-----------------------------------------------------
[fan]      #Fan- vventilador de capa
pin: PA0   #este pin controla el ventilador de capa y el ventilador de la BOARD CREALITY.

[mpu9250]
i2c_mcu: rpi
i2c_bus: i2c.1

[resonance_tester]
accel_chip: mpu9250
probe_points:
    117, 117, 20  # an example

[input_shaper]
shaper_type_x: 3hump_ei
shaper_freq_x: 82.0
shaper_type_y: mzv
shaper_freq_y: 36.6

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.614
#*# pid_ki = 1.141
#*# pid_kd = 122.201
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 71.109
#*# pid_ki = 1.140
#*# pid_kd = 1109.307
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.283750, 0.193750, 0.151250, 0.105000, 0.133750, 0.127500, 0.177500
#*# 	  0.183750, 0.098750, 0.080000, 0.047500, 0.088750, 0.087500, 0.127500
#*# 	  0.167500, 0.056250, 0.012500, -0.038750, -0.026250, -0.050000, -0.020000
#*# 	  0.168750, 0.076250, 0.030000, -0.028750, -0.015000, -0.047500, -0.027500
#*# 	  0.240000, 0.141250, 0.086250, 0.016250, 0.006250, -0.037500, -0.020000
#*# 	  0.308750, 0.201250, 0.158750, 0.082500, 0.078750, 0.032500, 0.042500
#*# 	  0.576250, 0.481250, 0.426250, 0.338750, 0.330000, 0.276250, 0.288750
#*# x_count = 7
#*# y_count = 7
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 5.0
#*# max_x = 207.98
#*# min_y = 10.0
#*# max_y = 220.0
#*#
#*# [probe]
#*# z_offset = 2.379
