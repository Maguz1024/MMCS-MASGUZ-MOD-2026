
#-------------------------------------------------------------------------------------------------------------------------
;Suavisa el golpeteo de los motores al hacer HOME inicial.
#[gcode_macro G28]
#description: Homing con suavizado inicial para evitar golpeteo
#rename_existing: G28.1
#gcode:
#    {% set settle_time = 200 %} ; tiempo de espera en ms

    # --- Habilitar motores antes de moverse ---
 #   SET_STEPPER_ENABLE STEPPER=stepper_x ENABLE=1
 #   SET_STEPPER_ENABLE STEPPER=stepper_y ENABLE=1
 #   SET_STEPPER_ENABLE STEPPER=stepper_z ENABLE=1
 #   G4 P{settle_time}   ; espera para que los drivers enganchen fase
  #  # --- Ejecutar homing real ---
   # G28.1

##############################################################################################
# -------------------------------------START_PRINT--------------------------------------------
##############################################################################################
# Replace the slicer's custom start and end g-code scripts with
# START_PRINT and END_PRINT. See docs/Slicers.md for more information on using these macros.
#añadir a OrcaSlicer: 
#START_PRINT EXTRUDER_TEMP=[nozzle_temperature_initial_layer] BED_TEMP=[bed_temperature_initial_layer_single] FILAMENT_PROFILE=[filament_type]

[gcode_macro START_PRINT] ;;actualizado 30-10-25
description: Inicio de impresión optimizado tipo Bambu Lab (nivelación con cama caliente)
variable_filament: ""
variable_bedtype: ''
gcode:
    M118 === START_PRINT iniciado ===

    {% set bed_temp = params.BED_TEMP|default(60)|float %}
    {% set extruder_temp = params.EXTRUDER_TEMP|default(200)|float %}
    {% set before_layer_change = params.BEFORE_LAYER_CHANGE|default(0)|int %}
    {% set curr_bed_type = params.CURR_BED_TYPE|default('none')|trim|string %}
    {% set filament_profile = params.FILAMENT_PROFILE|default("DESCONOCIDO")|string %}
    {% set preheat_nozzle_temp = 150.0 %} ; temperatura segura (para evitar goteo durante el ABL)

    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=bedtype VALUE='"{curr_bed_type}"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=filament VALUE='"{filament_profile}"'
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=inicial_filament_type VALUE='"{filament_profile}"'

    ;;M118 Tipo de cama detectado: {curr_bed_type}
    M118 Tipo de filamento: {filament_profile}

    {% if curr_bed_type == "High Temp Plate" %}
      M118 Tipo de cama detectado: {curr_bed_type}
      SET_GCODE_OFFSET Z=-0.369 #0.379
      #SET_GCODE_OFFSET Z_ADJUST=0.379 MOVE=1
    {% elif curr_bed_type == "Textured PEI Plate" %}
      M118 Tipo de cama detectado: {curr_bed_type}
      SET_GCODE_OFFSET Z=-0.140
      #SET_GCODE_OFFSET Z_ADJUST=0.150 MOVE=1
    {% else %}
      SET_GCODE_OFFSET Z=0.0
    {% endif %}

    # --- Preparación mecánica ---
    MMCS_SERVOuno_POS_0
    MMCS_SERVOdos_POS_0
    G4 P200
    CLEAR_PAUSE
    G90
    M83
    G28                                ; homing en frío para evitar goteo
    # --- Precalentamiento para ABL ---
    M118 Precalentando cama a {bed_temp}°C y hotend a {preheat_nozzle_temp}°C para nivelación
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={preheat_nozzle_temp}

    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={preheat_nozzle_temp}

    # --- Nivelación con cama caliente ---
    M118 Realizando Auto Bed Leveling con cama caliente
    BED_MESH_CALIBRATE
    _TOOLHEAD_PARK_PAUSE_CANCEL_NEW

    # --- Calentar a temperatura final ---
    M118 Calentando hotend a temperatura de impresión: {extruder_temp}°C
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}

    # --- Limpieza y purga ---
    ;;START_PRINT_PURGE
    CLEAN_NOZZLE_ADVANCED_START_PRINT
    ;;clean_nozzle_start_print_nozhop2
    SMART_PARK

    {% if before_layer_change == 0 %}
        M118 Realizando VORON_PURGE inicial...
        VORON_PURGE
        G92 E0
    {% else %}
        M118 No se ejecuta VORON_PURGE (before_layer_change ≠ 0)
    {% endif %}

    M118 === START_PRINT completado ===

;------------------------------------------------------------------------------------------------------------------------------------------

[gcode_macro END_PRINT]
variable_machine_y_depth: 230 #234  #Distancia (Y) usada por presentar impresion
variable_machine_x_depth: 249  #Distancia (X) usada por presentar impresion. Para mover el cabezal a la izquierda colocar este valor en "0".
gcode:  
    # Turn off bed and extruder.
    M140 S0    ;;apaga la cama caliente.
    M104 S0    ;;apaga el hotend
    # Relative positionning
    G91
    G1 E-20 F2000  ;retrae 20mm para evitar hilo de filamento al terminar la impresion. 
    # Sube el eje Z 10mm de forma segura sin pasar del límite físico,ejemp: si ya esta en Z máx (p. ej., 250 mm), no intentará subir más y no dara errores.
    {% set z_now = printer.toolhead.position.z|float %}
    {% set z_max = printer.toolhead.axis_maximum.z|float %}
    {% set z_safe_move = [z_now + 10.0, z_max] | min %}
    G90
    G1 Z{z_safe_move} F2600
    # Absolute positionning
    G90
    M106 S255   ##PENDINETE TESTEAR
    # Presenta la impresion.
    G1 X{machine_x_depth} Y{machine_y_depth} #Coloca el cabezal del lado derecho al terminar la impresion, para colocar el cabezal del lado izquierdo poner x en 0 (G1 X0)
    #limpia el nozzle al terminar la impresion.
    #codigo de limpieza aqui#
    ##M84 # Desactiva los motores   
    G4 P10000
    M106 S0    ;;apaga el fan de capa.
    M84 # Desactiva los motores
    SET_GCODE_OFFSET Z=0                           #borra los ajustes de z_offset que se hayan hecho en  los ajustes por filamnto.
    SAVE_VARIABLE VARIABLE=activeextruder VALUE=1
    SAVE_VARIABLE VARIABLE=tipo_cama VALUE=0        #reinicia la Variable Tipo de cama.
    M118 Impresion terminada
    BEEP2

;-Macro para aplicar ajustes dependiendo dl tipo de cama establecida en OrcaSlicer;
;PENDIENTE configurar todos los parametros necesarios pora cada tipo de filamento ;
[gcode_macro AJUSTES_POR_TIPO_CAMA]
description: Ajusta Pressure Advance y Z offset según tipo de cama y filamento
gcode:
    
    {% set bed_type = printer["gcode_macro START_PRINT"].bedtype|string %}
    {% set filament = printer["gcode_macro START_PRINT"].filament|string %}
    ;;{% set bed_type = params.BED_TYPE|string %}
    ;;{% set filament = params.FILAMENT|string %}

    # Tabla principal: { cama : { filamento : {pa, z} } }
    {% set settings_table = {
        "Textured PEI Plate": {
            "PLA":  {"pa": 0.034, "z": -0.010},
            "ABS":  {"pa": 0.035, "z": 0.00},
            "ASA":  {"pa": 0.030, "z": 0.00},
            "PETG": {"pa": 0.028, "z": 0.00}
        },
        "High Temp Plate": {
            "PLA":  {"pa": 0.021, "z": 0.00},
            "ABS":  {"pa": 0.029, "z": 0.00},
            "ASA":  {"pa": 0.030, "z": 0.00},
            "PETG": {"pa": 0.027, "z": 0.00}
        }
    } %}

    # Valores por defecto por filamento
    {% set default_by_filament = {
        "PLA":  {"pa": 0.022, "z": 0.00},
        "ABS":  {"pa": 0.030, "z": 0.00},
        "ASA":  {"pa": 0.030, "z": 0.00},
        "PETG": {"pa": 0.028, "z": 0.00}
    } %}

    # Valores globales por defecto
    {% set default_value = {"pa": 0.025, "z": 0.00} %}

    {% if bed_type in settings_table and filament in settings_table[bed_type] %}
        {% set cfg = settings_table[bed_type][filament] %}
        {action_respond_info("Ajuste según cama y filamento")}
    {% elif filament in default_by_filament %}
        {% set cfg = default_by_filament[filament] %}
        {action_respond_info("Ajuste por filamento (cama no encontrada)")}
    {% else %}
        {% set cfg = default_value %}
        {action_respond_info("Ajuste por valores globales por defecto")}
    {% endif %}

    # Aplicar Pressure Advance
    SET_PRESSURE_ADVANCE ADVANCE={cfg.pa}

    # Aplicar Z offset (relativo)
    SET_GCODE_OFFSET Z_ADJUST={cfg.z} MOVE=1

    {action_respond_info("PA: " ~ cfg.pa ~ " | Z offset: " ~ cfg.z ~ " para " ~ filament ~ " en " ~ bed_type)}

#----------------purga y retraccion----------------------------

[gcode_macro START_PRINT_PURGE]
description: Purga de 30mm de filamento antes de imprimir
gcode:
    {% set purge_length = 30 %}
    {% set purge_speed = 660 %}
    {% set retract = 3 %}
    
    M106 S255     #activa fan al 100%
    G4 P500      #espera medio segundo dando tiempo que el Fan llegue el 100%..
    G92 E0                    ; Reset extrusor
    G1 E{purge_length} F{purge_speed} ; Extruye 30mm
    G1 E-{retract} F{purge_speed}     ; Retrae un poco
    G92 E0                    ; Resetea extrusor
    G4 P500       #espera medio segundo antes de apagar el fan
    M106 S0       #apaga el fan de capa.

[gcode_macro END_PRINT_RETRAC]
description: Retrae 20mm de filamento al finalizar la impresión
gcode:
    {% set retract = 20 %}
    {% set retract_speed = 660 %}

    G91                      ; Movimiento relativo
    G1 E-{retract} F{retract_speed}   ; Retrae 20 mm
    G90                      ; Movimiento absoluto
#-----------------------------------------------------------

[gcode_macro _ENFRIAR_NOZZLE] ##PENDIENTE PROBAR SI FUNCIONA
gcode:
      M106 S255     #activa fan al 100%.
      G4 P15000     #espera 10 segundos.
      M106 S0       #apaga el fan de capa.

[gcode_macro LOW_TEMP_CHECK_PLA]
gcode:
    {% set extruder_temp = params.T|default(185)|float %}
    {% if printer.extruder.target > extruder_temp %}                            # if there is a setpoint for extruder
        {% set extruder_temp = printer.extruder.target %}
    {% endif %}
    {% if printer.extruder.temperature < extruder_temp %}                       # heat to the target
        M118 Heating to {extruder_temp}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    {% endif %}

[gcode_macro LOW_TEMP_CHECK_ABS]
gcode:
    {% set extruder_temp = params.T|default(230)|float %}
    {% if printer.extruder.target > extruder_temp %}                            # if there is a setpoint for extruder
        {% set extruder_temp = printer.extruder.target %}
    {% endif %}
    {% if printer.extruder.temperature < extruder_temp %}                       # heat to the target
        M118 Heating to {extruder_temp}
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp}
    {% endif %}

;;USO: se puede usar de la siguiente manera:  (COUNTDOWN TIME=60 MSG="mensaje aqui: " STEP=1)
[gcode_macro COUNTDOWN] ;;version actualizada
description: Cuenta regresiva con mensaje personalizado
gcode:
    {% set total_time = params.TIME|default(10)|int %}
    {% set message = params.MSG|default("Time: ") %}
    {% set step = params.STEP|default(1)|int %}   # intervalo de actualización en segundos

    {% for remaining in range(total_time, 0, -step) %}
        {% set wait_ms = step * 1000 %}
        M118 {message}{remaining}s
        G4 P{wait_ms}    ; espera step segundos
    {% endfor %}

    ; Mensaje final
    M118 {message}0s - Done!

 
##############################################################################################
##############################################################################################
#----------------------------------PURGE--RETRACT--------------------------------------------
##############################################################################################

[gcode_macro PURGE]                                 #purges 20mm and retracts 1mm when finished
variable_purge: 30
gcode:
    {% set E = printer["gcode_macro PURGE"].purge|float %}
    G1 E{E} F1000
    G92 E0                                          # Reset Extruder
    RETRACT_R
    BEEP3

[gcode_macro RETRACT_R]
variable_retract: 1
gcode:
    {% set R = printer["gcode_macro RETRACT_R"].retract|float %}
    G1 E-{R} F1000 
    G92 E0                                          # Reset Extruder


#---------------------------------------------------------------------



