[gcode_macro _CLIENT_VARIABLES]
# âš™ï¸ ConfiguraciÃ³n general para PAUSE / RESUME / CANCEL_PRINT
# ðŸ“Œ Todas las velocidades estÃ¡n en mm/s (Klipper las convierte a mm/min con *60)

variable_use_custom_pos   : True    # ðŸŽ¯ Usar coordenadas personalizadas de parqueo [True/False]

# ðŸ“ PosiciÃ³n de parqueo personalizada
variable_custom_park_x    : 249.00  # âž¡ï¸ PosiciÃ³n X
variable_custom_park_y    : 230.00  # â¬†ï¸ PosiciÃ³n Y
variable_custom_park_dz   : 2.0     # â¬†ï¸ Z-hop (subida al pausar)

# ðŸŽ¯ ExtrusiÃ³n / retracciÃ³n
variable_retract          : 2.0     # â†©ï¸ RetracciÃ³n al pausar
variable_cancel_retract   : 10.0    # âŒ RetracciÃ³n adicional en CANCEL_PRINT
variable_unretract        : 2.0 #1.5     # â†ªï¸ Des-retracciÃ³n al reanudar (antiguo valor 4)

# ðŸš€ Velocidades (mm/s â†’ Klipper multiplica *60 para F)
variable_speed_retract    : 35.0    # â†©ï¸ Velocidad retracciÃ³n
variable_speed_unretract  : 35.0    # â†ªï¸ Velocidad des-retracciÃ³n
variable_speed_hop        : 15.0    # â¬†ï¸ Velocidad de Z-hop
variable_speed_move       : 50.0    # âž¡ï¸ Velocidad de movimientos XY (DEFAULT 50)
;;variable_wipe_nozzle_speed: 50.0    # â¬…ï¸ âž¡ï¸ Velocidad de movimientos de limpieza.

# â¸ï¸ Comportamiento en CANCEL_PRINT
variable_park_at_cancel   : True    # ðŸŽ¯ Parquear cabezal al cancelar
variable_park_at_cancel_x : None    # âž¡ï¸ PosiciÃ³n X especÃ­fica en CANCEL_PRINT (None = usa la de arriba)
variable_park_at_cancel_y : None    # â¬†ï¸ PosiciÃ³n Y especÃ­fica en CANCEL_PRINT (None = usa la de arriba)

# ðŸ› ï¸ RetracciÃ³n por firmware (opcional)
variable_use_fw_retract   : False   # âš™ï¸ Usar fw_retraction en lugar de manual [True/False]

# â±ï¸ Tiempo de inactividad
variable_idle_timeout     : 0       # â±ï¸ Tiempo en segundos antes de idle_timeout (0 = deshabilitado)

# ðŸ“¡ Sensor de runout (opcional)
variable_runout_sensor    : ""      # ðŸ“¡ Nombre del sensor de filamento (ej: "filament_switch_sensor runout")

# ðŸ›‘ Macros de usuario personalizadas (se ejecutan en cada caso si no estÃ¡n vacÃ­as)
variable_user_pause_macro : ""      # â¸ï¸ DespuÃ©s de PAUSE_BASE
variable_user_resume_macro: ""      # â–¶ï¸ Antes de RESUME_BASE
variable_user_cancel_macro: ""      # âŒ Antes de CANCEL_PRINT_BASE
;;variable_wipe_nozzle_counts: 5
gcode:

#-Comando M220- modificado para que tome el factor de velocidad de mainsail, para reataurarlo posteriormente-#
# --- Interceptar M220 y guardar el factor de velocidad ---
[gcode_macro M220]
description: Intercepta el comando M220 para guardar el factor de velocidad
rename_existing: M220.1
variable_saved_speed_factor: 1.0
gcode:
    # Guardar el valor actual ANTES de que Mainsail lo cambie
    {% set current_factor = printer.gcode_move.speed_factor %}
    SET_GCODE_VARIABLE MACRO=M220 VARIABLE=saved_speed_factor VALUE={current_factor}
    # Ejecutar el M220 original con los parÃ¡metros recibidos
    M220.1 {rawparams}

# ---Macro para Restaurar el factor de velocidad guardado -----------------
[gcode_macro RESTORE_SPEED_FACTOR]
description: Restaura el Ãºltimo factor de velocidad guardado antes del M220
gcode:
    {% set saved = printer["gcode_macro M220"].saved_speed_factor|float %}
    M220 S{saved*100}
#____________________________________________________________________________

[gcode_macro PAUSE]
description: â¸ï¸ Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
  ##### get user parameters or use default ##### 
  {% set client = printer['gcode_macro _CLIENT_VARIABLES']|default({}) %}
  {% set idle_timeout = client.idle_timeout|default(0) %}
  {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}
  {% set restore = False if printer.toolhead.extruder == ''
              else True  if params.RESTORE|default(1)|int == 1 else False %}
  ##### end of definitions #####
  SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=last_extruder_temp VALUE="{{'restore': restore, 'temp': temp}}"
  # set a new idle_timeout value
  {% if idle_timeout > 0 %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=restore_idle_timeout VALUE={printer.configfile.settings.idle_timeout.timeout}
    SET_IDLE_TIMEOUT TIMEOUT={idle_timeout}
  {% endif %}
  PAUSE_BASE
  {client.user_pause_macro|default("")}
  _TOOLHEAD_PARK_PAUSE_CANCEL_NEW

#########RESUME################################
[gcode_macro RESUME]
description: â–¶ï¸ Resume the actual running print
rename_existing: RESUME_BASE
variable_last_extruder_temp: {'restore': False, 'temp': 0}
variable_restore_idle_timeout: 0
variable_idle_state: False
gcode:
  ;reestablece la velocidad que se tomo al momento de pausar 

  RESPOND type="command" msg="action:prompt_end"  #cierra la ventana de dialogo CONFIRMACION M600

  ##### get user parameters or use default #####
  {% set client = printer['gcode_macro _CLIENT_VARIABLES']|default({}) %}
  {% set runout_resume = True if client.runout_sensor|default("") == ""     # no runout
                    else True if not printer[client.runout_sensor].enabled  # sensor is disabled
                    else printer[client.runout_sensor].filament_detected %} # sensor status
  {% set can_extrude = True if printer.toolhead.extruder == ''           # no extruder defined in config
                  else printer[printer.toolhead.extruder].can_extrude %} # status of active extruder
  {% set do_resume = False %}
  {% set prompt_txt = [] %}

  # âš¡ Siempre usar velocidades fijas
  {% set sp_hop   = (client.speed_hop|default(15)) * 60 %}   ; mm/s â†’ mm/min
  {% set sp_move  = (client.speed_move|default(40)) * 60 %}  ; mm/s â†’ mm/min

  ##### Printer coming from timeout idle state #####
  {% if printer.idle_timeout.state|upper == "IDLE" or idle_state %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=False
    {% if last_extruder_temp.restore %}
      RESPOND TYPE=echo MSG='{"Restoring \"%s\" temperature to %3.1f\u00B0C, this may take some time" % (printer.toolhead.extruder, last_extruder_temp.temp) }'
      M109 S{last_extruder_temp.temp}
      {% set do_resume = True %}
    {% elif can_extrude %}
      {% set do_resume = True %}
    {% else %} 
      RESPOND TYPE=error MSG='{"Resume aborted !!! \"%s\" not hot enough, please heat up again and press RESUME" % printer.toolhead.extruder}'
      {% set _d = prompt_txt.append("\"%s\" not hot enough, please heat up again and press RESUME" % printer.toolhead.extruder) %}
    {% endif %}
  ##### Printer coming out of regular PAUSE state #####
  {% elif can_extrude %}
    {% set do_resume = True %}
  {% else %}
    RESPOND TYPE=error MSG='{"Resume aborted !!! \"%s\" not hot enough, please heat up again and press RESUME" % printer.toolhead.extruder}'
    {% set _d = prompt_txt.append("\"%s\" not hot enough, please heat up again and press RESUME" % printer.toolhead.extruder) %}
  {% endif %}

  {% if runout_resume %}
    {% if do_resume %}
      {% if restore_idle_timeout > 0 %} SET_IDLE_TIMEOUT TIMEOUT={restore_idle_timeout} {% endif %} # restore idle_timeout time
      {client.user_resume_macro|default("")}
      _CLEAN_NOZZLE_RESUME #nuevo 20-11-25 probar
      _CLIENT_EXTRUDE
      # âš¡ Movimiento controlado con velocidades fijas
      RESUME_BASE VELOCITY={sp_move*60}                        ; reanuda con velocidad fija para los movimientos de regreso
    {% endif %}
  {% else %}
    RESPOND TYPE=error MSG='{"Resume aborted !!! \"%s\" detects no filament, please load filament and press RESUME" % (client.runout_sensor.split(" "))[1]}'
    {% set _d = prompt_txt.append("\"%s\" detects no filament, please load filament and press RESUME" % (client.runout_sensor.split(" "))[1]) %}
  {% endif %}

  ##### Generate User Information box in case of abort #####
  {% if not (runout_resume and do_resume) %} 
    RESPOND TYPE=command MSG="action:prompt_begin RESUME aborted !!!"
    {% for element in prompt_txt %}
      RESPOND TYPE=command MSG='{"action:prompt_text %s" % element}' 
    {% endfor %}
    RESPOND TYPE=command MSG="action:prompt_footer_button Ok|RESPOND TYPE=command MSG=action:prompt_end|info"
    RESPOND TYPE=command MSG="action:prompt_show"
  {% endif %}

########################CANCEL-PRINT##############################

[gcode_macro CANCEL_PRINT]
description: âŒ Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  ##### get user parameters or use default #####
  SAVE_VARIABLE VARIABLE=tipo_cama VALUE=0 ##reinicia la Variable Tipo de cama.
  {% set client = printer['gcode_macro _CLIENT_VARIABLES']|default({}) %}
  {% set allow_park = client.park_at_cancel|default(false)|lower == 'true' %}
  {% set retract = client.cancel_retract|default(5.0)|abs %}
  ##### define park position #####
  {% set park_x = "" if (client.park_at_cancel_x|default(none) is none)
            else "X=" ~ client.park_at_cancel_x %}
  {% set park_y = "" if (client.park_at_cancel_y|default(none) is none)
            else "Y=" ~ client.park_at_cancel_y %}
  {% set custom_park = park_x|length > 0 or park_y|length > 0 %}
  ##### end of definitions #####
  # restore idle_timeout time if needed
  {% if printer['gcode_macro RESUME'].restore_idle_timeout > 0 %}
    SET_IDLE_TIMEOUT TIMEOUT={printer['gcode_macro RESUME'].restore_idle_timeout}
  {% endif %}
  {% if (custom_park or not printer.pause_resume.is_paused) and allow_park %} _TOOLHEAD_PARK_PAUSE_CANCEL_NEW {park_x} {park_y} {% endif %}
  _CLIENT_RETRACT LENGTH={retract}
  TURN_OFF_HEATERS
  M106 S0
  {client.user_cancel_macro|default("")}
  SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=False
  # clear pause_next_layer and pause_at_layer as preparation for next print
  SAVE_VARIABLE VARIABLE=activeextruder VALUE=1
  SET_PAUSE_NEXT_LAYER ENABLE=0
  SET_PAUSE_AT_LAYER ENABLE=0 LAYER=0
  SET_GCODE_OFFSET Z=0  
  CANCEL_PRINT_BASE

[gcode_macro _TOOLHEAD_PARK_PAUSE_CANCEL_NEW]
description: Helper: park toolhead used in PAUSE and CANCEL_PRINT
gcode:
  ##### get user parameters or use default #####
  {% set client = printer['gcode_macro _CLIENT_VARIABLES']|default({}) %}
  {% set use_custom     = client.use_custom_pos|default(false)|lower == 'true' %}
  {% set custom_park_x  = client.custom_park_x|default(0.0) %}
  {% set custom_park_y  = client.custom_park_y|default(0.0) %}
  {% set park_dz        = client.custom_park_dz|default(2.0)|abs %}

  # âš¡ Siempre usar velocidades fijas definidas en _CLIENT_VARIABLES (mm/s â†’ mm/min)
  {% set sp_hop  = (client.speed_hop|default(15)) * 60 %}
  {% set sp_move = (client.speed_move|default(40)) * 60 %}

  ##### get config and toolhead values #####
  {% set origin    = printer.gcode_move.homing_origin %}
  {% set act       = printer.gcode_move.gcode_position %}
  {% set max       = printer.toolhead.axis_maximum %}
  {% set cone      = printer.toolhead.cone_start_z|default(max.z) %} ; height as long the toolhead can reach max and min of an delta
  {% set round_bed = True if printer.configfile.settings.printer.kinematics is in ['delta','polar','rotary_delta','winch']
                else False %}
  ##### define park position #####
  {% set z_min = params.Z_MIN|default(0)|float %}
  {% set z_park = [[(act.z + park_dz), z_min]|max, (max.z - origin.z)]|min %}
  {% set x_park = params.X       if params.X is defined
             else custom_park_x  if use_custom
             else 0.0            if round_bed
             else (max.x - 5.0) %}
  {% set y_park = params.Y       if params.Y is defined
             else custom_park_y  if use_custom
             else (max.y - 5.0)  if round_bed and z_park < cone
             else 0.0            if round_bed
             else (max.y - 5.0) %}
  ##### end of definitions #####
  _CLIENT_RETRACT
  {% if "xyz" in printer.toolhead.homed_axes %}
    G90
    G1 Z{z_park} F{sp_hop*60}         ; movimiento vertical con velocidad fija
    G1 X{x_park} Y{y_park} F{sp_move*60} ; movimiento XY con velocidad fija
    {% if not printer.gcode_move.absolute_coordinates %} G91 {% endif %}
  {% else %}
    RESPOND TYPE=echo MSG='Printer not homed'
  {% endif %}

