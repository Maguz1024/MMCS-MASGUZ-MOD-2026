;´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´;
;Esta es una nueva version del codigo para multicolor, ahora llamada (MMCS_AUTOMATIC_FILAMENT_CHANGE_V1),en esta version ya no se;
;usa el tipo de filamento ejemp,(PLA,PLA1,PLA2,PLA3 y ABS1,ABS2) para el codigo de cambio de color, ahora en su lugar se usa el  ;
;numero de EXTRUSOR actual y siguiente T0,T1,T2,T3, para hacer los cambios de color (filamentos),por eso ahora ya no es necesario;
;modificar el nombre del filamento en OrcaSlicer tal como lo haciamos antes ejmp: cambiarle el nombre (PLA1 para color #1), ahora;
;podemos escoger los filamentos que necesitemos en OrcaSlicer, sin necesidad de modificarles el nombre---------------------------;
;-Ahora las variables ya no se almacenan en (MMCS_AUTOMATIC_FILAMENT_CHANGE_V1), en su logar se almacenaran fuera de ella en ----;
;en variables globales dentro de (_MMCS_VARS).

;para sincronizar el MANUAL_STEPPER, con EXTRUDER, hay que usar el comando (SYNC=0), el cual hace que ambos se muevan ala msimo tiempo:
##SYNC=1 = movimiento bloqueante (secuencial),esta activo popr defecto bloquea los otros movimientos lo que impide que se mueva justo a extruder= movimientos G1.
##SYNC=0 = movimiento no bloqueante (paralelo)= permite mover en simultanio con otros movimientos G1 ejemplo, sincronizado con el extrusor o otros ejes.
# ejemplo si ejecutamos: 
#        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE=20 SPEED=6 SYNC=0
#        G1 E20  F100
#ambos comandos se ejecutaran al mismo tiempo, se movera el manual_stepper y el extruder.

#------------------------------------------------------Preparar--OrcaSlicer----------------------------------------------------------------------------------------#
# 1) Preparar el slicer en este caso OrcaSlicer, para capturar el tipo de nuevo filamento en cada llamada de cambio de filamento.----------------------------------#
# para esto debemos agregar la siguente linea de ABAJO en la seccion (change_filament_gcode) o (gcode para cambio de filamento)------------------------------------#
# MMCS_AUTOMATIC_FILAMENT_CHANGE_V1 FILAMENT_TYPE=[filament_type] NEW_FILAMENT_TYPE=[filament_type] CURR_EXTRUDER=[current_extruder] NEXT_EXTRUDER=[next_extruder] #
# esa linea de codigo captura los parametros necesarios que seran utilizados por el codigo de "MMCS_AUTOMATIC_FILAMENT_CHANGE_V1", para su correcto funcionamiento-#
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------#
#ACTUALIZACION: ya no se necesita un  boton fisico para RESUMIR, ya el codigo resume automaticamente.
;27-8 agregado codigo para verificar si el filamento se cargo correctamente antes de RESUMIR. linea 158.

;-------Variables usadas por [MMCS_COLOR_CHANGE_V1]---------------------------;
[gcode_macro _MMCS_VARS]
description: Guarda todas las variables usadas por MMCS_COLOR_CHANGE_V1 y otros.
variable_inicial_filament_type: ''          #filamento inicial, esta variables es enviada desde (START_PRINT), hasta (inicial_filament_type) .
variable_new_filamen_type: ''
variable_wipe_nozzle_counts: 5
;------------------------
;filament--sensor
variable_filament_sensor_extruder1: 1       #(hace referencia al sensor debajo del extrusor.)

;EXTRUDER
variable_ex_cross_gears_move: 20  
variable_load_gears_to_nozzle: 110          #distancia desde los engranages del extrusor, hasta la boquilla.
variable_ex_cross_speed: 360                ;esta velocidad debe ser igual a (ms_cross_speed)
variable_load_speed: 420        ;=7         #velocidad para carga de filamento.
variable_purge_extra: 10 #30                #purga la cantidad establecida, default (20), despues de cargar el filamento.

;pendiente cambiar nombre initialpos por (park posicion)
;-- manual stepper (MS) -VARIABLES--estas velocidades van en valores diferentes a EXTRUDER.
variable_ms_gears_to_initialpos: 75         #distancia desde los engranages del extrusor, hasta la posicion inicial superior. valor anterior 3.40
variable_ms_initialpos_to_gears: 75         #distacia desde la posicion inicial del filamento, hasta los engranages del ectrusor + 10mm, seria el valor de (unload_gears_to_initialpos +10mm), (75+10=85mm).
variable_ms_cross_gears_move: 20            #(paso de engranages)ayuda a que el filamento atraviese correctamente los engranages del extrusor.
variable_ms_cross_speed: 6      ;=F360      #velocidad (paso de engranages), ejemplo 6 = F360, esta velocidad debe ser iguala a (ex_cross_speed), la que usa el extrusor cuando hala el fialmento desde los engranages.
variable_ms_unload_speed: 50                #velocidad para descargar el filamento, ejemplo 50 = F=3000
variable_ms_load_speed: 50                  #velocidad para carga de filamento hasta los engranages, ejemplo 5 = F300

variable_automatic_changfilament: 1         #activa/desactiva, el modo de cambio de filamento automatico defaul "1", cambie a "0" para cambio de filamento manual.
;------colores selector-define-que-colores-cambiaran-automaticamente-----
;aca se guardaran las variables obtenidas desde (save_variables), por la macro (READ_ACTIVED_COLORS) ,
;las cuales corresponden a los colores automaticos que han sido seleccionados en la pantalla de KlipperScreen seccion (Multicolor).
;todas se ven en "0" como defaul, los valores reales estan almacenados (save_variables).
variable_automatic_color1: 0
variable_automatic_color2: 0
variable_automatic_color3: 0
variable_automatic_color4: 0

;------servo-1-variables-------(colors 1 y 2)
variable_mmcs_servo_up_angle: 120      #posicion 1
variable_mmcs_servo_mid_angle: 75      #posicion 0
variable_mmcs_servo_down_angle: 60     #posicion 2

;------servo-2-variables-------(colors 3 y 4)
variable_mmcs_servo2_up_angle: 48      #posicion 1
variable_mmcs_servo2_mid_angle: 25     #posicion 0
variable_mmcs_servo2_down_angle: 2     #posicion 2

variable_extra_time_servo_up: 0         #tiempo extra solo de ser necesario.
variable_extra_time_servo_down: 0       #tiempo extra solo de ser necesario.
variable_extra_time_servo_mid: 0        #tiempo extra solo de ser necesario.
variable_extrusor_act: 0
variable_extrusor_sig: 0
variable_color_act: 0                   #esta variable contiene el valor ya convertido en la seccion (codigos para la conversion de valores).
variable_color_nuevo: 0                 #esta variable contiene el valor ya convertido en la seccion (codigos para la conversion de valores).
;------------------END-VARIABLES--------------------------------;
gcode:
 
[gcode_macro READ_ACTIVED_COLORS]
#[gcode_macro SET_COLOR_AUTO_VARIABLES]
description: Lee el estado de los colores automaticos, para saber cuales estan activados o esactivados, luego los guarda en (_MMCS_VARS).
gcode:
    {% set vars = printer["save_variables"].variables %}

    {% set automatic_color1 = 1 if vars.colorautomatico1 else 0 %}
    {% set automatic_color2 = 1 if vars.colorautomatico2 else 0 %}
    {% set automatic_color3 = 1 if vars.colorautomatico3 else 0 %}
    {% set automatic_color4 = 1 if vars.colorautomatico4 else 0 %}

    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=automatic_color1 VALUE={automatic_color1}
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=automatic_color2 VALUE={automatic_color2}
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=automatic_color3 VALUE={automatic_color3}
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=automatic_color4 VALUE={automatic_color4}

    {% set mensaje = "Variables booleanas actualizadas: 1=" ~ automatic_color1 ~ " 2=" ~ automatic_color2 ~ " 3=" ~ automatic_color3 ~ " 4=" ~ automatic_color4 %}
    M118 {mensaje}

[gcode_macro MMCS_COLOR_CHANGE_V1]
description:Esta macro es la encargada de gestionar los cambios de color (filamentos), automaticamente usando el sistema MMCS.
variable_anterior_filamen_type: ''     #al usar esta variable dentro la misma macro,mostrara el valor guardado anteriormente, en este caso mostrara el tipo de filamento anterior
gcode:
    ;Limpia variables anteriores para ecvitar errores.
    SAVE_VARIABLE VARIABLE=unload_warning VALUE=0
    SAVE_VARIABLE VARIABLE=load_warning VALUE=0
    SAVE_VARIABLE VARIABLE=manual_mode VALUE=0

    
    READ_ACTIVED_COLORS #Lee que  colores estan activados o desactivados y los guarda en (colores selector dentro de (_MMCS_VARS)). 
    SAVE_GCODE_STATE NAME=MMCS_COLOR_CHANGE_V1_STATE

    ;-----------definicion---------------------
    {% set AUTO_FILAMENT_CHANG = printer["gcode_macro _MMCS_VARS"].automatic_changfilament|int %}
    {% set NEW_FILAMENT_TYPE = params.NEW_FILAMENT_TYPE|default('none')|string %} #obtiene el tipo de filamento desde OrcaSlicer, en la seccion GCODE para cambio de filamento, el cual se actualizara cada vez que se ejecute un cambio de color.
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=new_filamen_type VALUE='"{NEW_FILAMENT_TYPE}"'

    {% set OLD_FILAMENT = printer["gcode_macro _MMCS_VARS"].color_act|int %}
    ;___  test-captura extrusor-actual-y siguiente____
    {% set extrusor_actual = params.CURR_EXTRUDER|int %} ;el (current_extruder) o extrusor actual quedaria como el extrusor anterior, ya que fue el ultimo que se uso.
    {% set extrusor_siguiente = params.NEXT_EXTRUDER|int %}     ;next_extruder seria el nuevo extrusor a usar.
    {% set FILA_SENSOR_EX1 = printer["gcode_macro _MMCS_VARS"].filament_sensor_extruder1|int %} 
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=extrusor_act VALUE={extrusor_actual}
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=extrusor_sig VALUE={extrusor_siguiente}

;----captura la el factor de velocidad actual que usa mainsail, para restaurarlo al terminar el cambio de color
#   {% set current_speed = printer.gcode_move.speed_factor %}
#   SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=saved_speed_fact VALUE={printer.gcode_move.speed_factor}
#   M118 la velosidad guardada es: {current_speed}

;################################-codigos para la conversion de valores -########################################;
;-este codigo toma el numero de extrusor pasado como parametro desde OrcaSlicer, y lo convierte a un numero mayor;
;-ejemp:                                                                                                         ;
;-de T0, toma el "0" y lo eleva a "1"| ahora T0 seria = a 1 que a su vez sera =color #1                          ;
;-de T1, toma el "1" y lo eleva a "2"| ahora T1 seria = a 2 que a su vez sera =color #2                          ;
;-de T2, toma el "2" y lo eleva a "3"| ahora T2 seria = a 3 que a su vez sera =color #3                          ;
;-de T3, toma el "3" y lo eleva a "4"| ahora T3 seria = a 4 que a su vez sera =color #4                          ;
;-esto hara mas facil el codigo para carga y descarga ya que no se usara 0,1,2,3,4 en el codigo para comprobacion;
;-como en este caso: {% if ACTUAL_COLOR == 0 %} donde se usa "0" para comprobar el color 1 equivalente a "T0",   ;
;-ahora en cambio podemos usat "1" derectamente para comprobar el color #1 {% if ACTUAL_COLOR == 1 %}            ;
;-quedando asi los colores 1,2,3,4 equivalentes a 4 colores y no 0,1,2,3.                                        ;

    {% if 'CURR_EXTRUDER' in params %} ;toma el valor de (CURR_EXTRUDER) pasado como parametro desde OrcaSlicer
        # Convertimos el valor del parámetro a un número entero
        {% set curr_extruder = params.CURR_EXTRUDER|int %}
        # Incrementamos el valor en 1
        {% set curr_extruder_convr = curr_extruder + 1 %}
        SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=color_act VALUE={curr_extruder_convr} ;guarda el numero de extrusor ya convertido en la variable (color_act).
        # Imprimimos el resultado en la consola de Klipper
        M118 El color actual es: T{curr_extruder} convertido a: {curr_extruder_convr}
    {% else %}
        M118 ERROR: La macro de conversion requiere el parámetro CURR_EXTRUDER.
    {% endif %}

    {% if 'NEXT_EXTRUDER' in params %}
        # Convertimos el valor del parámetro a un número entero
        {% set nxt_extruder = params.NEXT_EXTRUDER|int %}
        # Incrementamos el valor en 1
        {% set nxt_extruder_convr = nxt_extruder + 1 %}
        SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=color_nuevo VALUE={nxt_extruder_convr} ;guarda el numero de extrusor ya convertido en la variable (color_nuevo).
        # Imprimimos el resultado en la consola de Klipper
        M118 El nuevo color es: T{nxt_extruder} convertido a: {nxt_extruder_convr}
    {% else %}
        M118 ERROR: La macro de conversion requiere el parámetro NEXT_EXTRUDER.
    {% endif %}

;mensajes de acciones......
    M118 Cambiando de extrusor T{extrusor_actual} → T{extrusor_siguiente}
    EXTENDED_RESPOND PREFIX=":" PREFIX_COLOR="info" MSG="MMCS_COLOR_CHANGE_V1 Ejecutado..." COLOR="success"
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Changing filament...." COLOR="success"
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Filamento anterior:{OLD_FILAMENT} en T{extrusor_actual}" COLOR="success"             #muestra un mensaje con el filamento anterior.
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cambiando a nuevo filamento:{NEW_FILAMENT_TYPE} en T{extrusor_siguiente}" COLOR="success"   #muestra un mensaje con el filamento actual.
#-------------------------VERIFICA SI LA IMPRESORA ESTA PAUSADA---------------------------------------------#
    {% if printer.pause_resume.is_paused %}
      EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG=" Print Already paused.." COLOR="success"  #agregado nuevo15/12
    {% else %}
      {% if printer.toolhead.homed_axes != "xyz" %}
          M118 Homing
          G28                                                            # home if not homed
      {% else %}
          EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Pausing print...." COLOR="success"
          PAUSE
      {% endif %}
    {% endif %}
    SET_IDLE_TIMEOUT TIMEOUT=7200
    MMCS_AUTO_FILA_UNLOAD
    G4 P2000               #crea una pausa entre UNLOAD_MOD y LOAD_MOD #NUEVO 23/11
    MMCS_AUTO_FILA_LOAD
    RESTORE_GCODE_STATE NAME=MMCS_COLOR_CHANGE_V1_STATE
    ;;;UPDATE_DELAYED_GCODE ID=MMCS_COLOR_CHANGE_V1_RESUME DURATION=2 ##RESUME automaticamente 2 segundos despues. 

#[gcode_macro FILAMENT_IN_EXTRUDER1]
#gcode:
#    ;si el sensor esta HABILITADO, verifica si el filamento se cargo correctamente antes de reanudar la impresion, si esta DESHABILITADO, continua la impresion sin ninguna comprobacion.
#    {% set FILA_SENSOR_EX1 = printer["gcode_macro _MMCS_VARS"].filament_sensor_extruder1|int %} 
#    {% if FILA_SENSOR_EX1 == 1 %}
#        {% if printer["filament_switch_sensor filament_sensor1"].filament_detected %}
#            M118 ⚠️ Hay un Filamento detectado en el extrusor, por favor retirelo para poder cargar el nuevo fialemento.
#             SAVE_VARIABLE VARIABLE=filament_in_extruder1 VALUE=1
#        {% else %} ;si no es detectado
#            SAVE_VARIABLE VARIABLE=filament_in_extruder1 VALUE=0
#    {% endif %}
#    {% endif %}

#[gcode_macro EXTRUDER_LOAD_FILA_SENSOR1]
#gcode:
;si el sensor esta HABILITADO, verifica si el filamento se cargo correctamente antes de reanudar la impresion, si esta DESHABILITADO, continua la impresion sin ninguna comprobacion.
#    {% set NEW_COLOR = printer["gcode_macro _MMCS_VARS"].color_nuevo %}
#    {% set FILA_SENSOR_EX1 = printer["gcode_macro _MMCS_VARS"].filament_sensor_extruder1|int %} 
#    {% if FILA_SENSOR_EX1 == 1 %}
#        {% if printer["filament_switch_sensor filament_sensor1"].filament_detected %}
#            M118 ✅ Filamento {NEW_COLOR} cargado correctamente
#            EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Filamento {NEW_COLOR} cargado correctamente en el extrusor...." COLOR="success"
#            SAVE_VARIABLE VARIABLE=sensor_warning_extruder1 VALUE=0
#        {% else %} ;si no es detectado
#            SAVE_VARIABLE VARIABLE=sensor_warning_extruder1 VALUE=1
#            M118  ⚠️ Error: Filamento {NEW_COLOR} no detectado
#            EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="El Filamento {NEW_COLOR} no se cargo correctamente en el extrusor, por favor verificar extrusor." COLOR="warning"
#        {% endif %}
#    {% else %} ;si el sensor esta desactivado, continua sin comprobacion.
#        M118 Comprobación del sensor de filamento del extrusor deshabilitada.
#    {% endif %}

[delayed_gcode MMCS_COLOR_CHANGE_V1_RESUME]
gcode:
    {% if printer.pause_resume.is_paused %}
        M118 Resuming print
        clean_nozzle_nozhop_mmcs ;limpia la boquilla
        RESUME
        RESTORE_SPEED_FACTOR
    {% endif %}
#pendiente testear su funcionamiento a este nuevo codigo para resumir

#[delayed_gcode MMCS_COLOR_CHANGE_V1_RESUME]
#gcode:
#    {% if printer.pause_resume.is_paused %}
#        {% set unload_warning = printer.save_variables.variables.unload_warning|default(0)|int %}
#        {% set load_warning = printer.save_variables.variables.load_warning|default(0)|int %}
#        {% set manual_mode = printer.save_variables.variables.manual_mode|default(0)|int %}
#        {% set sensor_warning_extruder1 = printer.save_variables.variables.sensor_warning_extruder1|default(0)|int %}
#        {% set filament_in_extruder1 = printer.save_variables.variables.filament_in_extruder1|default(0)|int %}
#        
#        {% if unload_warning == 0 and filament_in_extruder1 == 0 and load_warning == 0 and manual_mode == 0 and sensor_warning_extruder1 == 0 %}
#            M118 ✅ No hay errores activos, reanudando impresión...
#            clean_nozzle_nozhop_mmcs
#            RESUME
#            RESTORE_SPEED_FACTOR
#        {% elif filament_in_extruder1 == 1 %}
#            M118 ⚠️ Hay un filamento detectado en el extrusor, por favor retírelo para poder cargar el nuevo filamento.
#            M118 ⚠️ Manteniendo impresión en pausa hasta resolver el error.
#        {% elif load_warning == 1 %}
#            M118 ⚠️ Problema detectado durante la carga (load_warning). Por favor verifique y reanude manualmente la impresión.
#            M118 ⚠️ Manteniendo impresión en pausa hasta resolver el error.
#        {% elif unload_warning == 1 %}
#            M118 ⚠️ Problema detectado durante la descarga (unload_warning). Por favor verifique y reanude manualmente la impresión.
#            M118 ⚠️ Manteniendo impresión en pausa hasta resolver el error.
#        {% elif manual_mode == 1 %}
#            M118 ⚠️ Modo manual activado (manual_mode). Cargue o descargue el filamento manualmente y luego reanude la impresión.
#            M118 ⚠️ Manteniendo impresión en pausa hasta resolver el error.
#        {% elif sensor_warning_extruder1 == 1 %}
#            M118 ⚠️ Warning detectado en el sensor del extrusor (sensor_warning_extruder1).
#            M118 ⚠️ Manteniendo impresión en pausa hasta resolver el error.
#        {% else %}
#            M118 ⚠️ Error no identificado, manteniendo impresión en pausa.
#        {% endif %}
#    {% else %}
#        M118 La impresión no está en pausa, no se ejecuta RESUME.
#    {% endif %}

#----------------------------------DESCARGA DE FILAMENTO-------------------------------------------------------#
[gcode_macro MMCS_AUTO_FILA_UNLOAD]
description: Macro encargada de gestionar la descarga y el moldeado de punta, dependiendo el tipo de filamento, para luejo ejecutarla en MMCS_UNLOAD.
gcode:
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="MMCS_AUTO_FILA_UNLOAD ejecurado...." COLOR="success"
    {% set timer = params.T|default(6)|float %}
    {% set INICIAL_FILAMENT_TYPE = printer["gcode_macro _MMCS_VARS"].inicial_filament_type|string %}   #toma el tipo de filamento inicial desde (MMCS_COLOR_CHANGE_V1), el cual lo recibe desde START_PRINT.
    ;Este codigo aplica el TIP FORMING dependiendo del tipo de material o (filamento).
    {% set material_type = printer["gcode_macro _MMCS_VARS"].inicial_filament_type ;Este codigo omite los numeros y toma solo el texto ejemp; de PLA1, toma solo PLA y omite el numero 1.
         | replace('1','')
         | replace('2','')
         | replace('3','')
         | replace('4','') %}

    {% if material_type == 'PLA' %}
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Moldeando punta de filamento:{material_type}" COLOR="success"
        LOW_TEMP_CHECK_PLA # NUEVO
        ;MMCS_FORM_TIP_STANDALONE
        ERCF_FORM_TIP_STANDALONE
        G4 P1000
        MMCS_UNLOAD
    {% elif material_type == 'ABS' or material_type == 'ASA' %}
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Moldeando punta de filamento:{material_type}" COLOR="success"
        LOW_TEMP_CHECK_ABS #NUEVO
        ;MMCS_FORM_TIP_STANDALONE
        ERCF_FORM_TIP_STANDALONE
        G4 P1000
        MMCS_UNLOAD
    {% elif material_type == 'PETG' %}
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Moldeando punta de filamento:{material_type}" COLOR="success"
        LOW_TEMP_CHECK_ABS           #Pendiente configurar parametros para PETG.
        ;MMCS_FORM_TIP_STANDALONE
        ERCF_FORM_TIP_STANDALONE     #Pendiente configurar parametros para PETG.
        G4 P1000
        MMCS_UNLOAD
    {% else %}
        M118 Material no reconocido NO  se pudo Descargar
    {% endif %}

[gcode_macro MMCS_UNLOAD]
description: Esta macro descarga el filamento previamente gestionado por (MMCS_AUTO_FILA_UNLOAD).
gcode:
    {% set AUTOMATIC_COLOR_1 = printer["gcode_macro _MMCS_VARS"].automatic_color1|int %}
    {% set AUTOMATIC_COLOR_2 = printer["gcode_macro _MMCS_VARS"].automatic_color2|int %}
    {% set AUTOMATIC_COLOR_3 = printer["gcode_macro _MMCS_VARS"].automatic_color3|int %}
    {% set AUTOMATIC_COLOR_4 = printer["gcode_macro _MMCS_VARS"].automatic_color4|int %}
    {% set MS_UNLOAD_SPEED = printer["gcode_macro _MMCS_VARS"].ms_unload_speed|float %}
    {% set MS_GEARS_INITIALPOS = printer["gcode_macro _MMCS_VARS"].ms_gears_to_initialpos|float %}
    {% set ACTUAL_COLOR = printer["gcode_macro _MMCS_VARS"].color_act|int %}

    MANUAL_STEPPER STEPPER=mmcs_stepper ENABLE=1 ;;habilita el MANUAL_STEPPER
    ###{% set wait_ms_unload = (MS_GEARS_INITIALPOS / MS_UNLOAD_SPEED * 1000)|int %}
    
    {% if ACTUAL_COLOR == 1 and AUTOMATIC_COLOR_1|int == 1 %} ;COLOR #1
      #MMCS_SERVO_POS_1
      MMCS_SERVOuno_POS_1
      G4 P400
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      MANUAL_STEPPER STEPPER=mmcs_stepper MOVE={MS_GEARS_INITIALPOS} SPEED={MS_UNLOAD_SPEED}
      ####G4 P{wait_ms_unload}
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      #MMCS_SERVO_POS_0
      MMCS_SERVOuno_POS_0
      G4 P200

    {% elif ACTUAL_COLOR == 2 and AUTOMATIC_COLOR_2|int == 1 %} ;COLOR #2
      #MMCS_SERVO_POS_2
      MMCS_SERVOuno_POS_2
      G4 P400
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      MANUAL_STEPPER STEPPER=mmcs_stepper MOVE=-{MS_GEARS_INITIALPOS} SPEED={MS_UNLOAD_SPEED}
      ###G4 P{wait_ms_unload}
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      #MMCS_SERVO_POS_0
      MMCS_SERVOuno_POS_0
      G4 P200

    {% elif AUTOMATIC_COLOR_2|int == 0 %}
      SAVE_VARIABLE VARIABLE=manual_mode VALUE=1
      EXTENDED_RESPOND PREFIX="RETIRE el filamento 2, del EXTRUSOR manualmente por favor." PREFIX_COLOR="warning"
      G4 P8000
    
    {% elif ACTUAL_COLOR == 3 and AUTOMATIC_COLOR_3|int == 1 %} ;COLOR #3
      #MMCS_SERVO_POS_3
      MMCS_SERVOdos_POS_3
      G4 P400
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      MANUAL_STEPPER STEPPER=mmcs_stepper MOVE={MS_GEARS_INITIALPOS} SPEED={MS_UNLOAD_SPEED}
      ####G4 P{wait_ms_unload}
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      #MMCS_SERVO_POS_0
      MMCS_SERVOdos_POS_0
      G4 P200

    {% elif AUTOMATIC_COLOR_3|int == 0 %}
      SAVE_VARIABLE VARIABLE=manual_mode VALUE=1
      EXTENDED_RESPOND PREFIX="RETIRE el filamento 3, del EXTRUSOR manualmente por favor." PREFIX_COLOR="warning"
      G4 P8000

    {% elif ACTUAL_COLOR == 4 and AUTOMATIC_COLOR_4|int == 1 %} ;COLOR #4
      #MMCS_SERVO_POS_4
      MMCS_SERVOdos_POS_4
      G4 P400
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      MANUAL_STEPPER STEPPER=mmcs_stepper MOVE=-{MS_GEARS_INITIALPOS} SPEED={MS_UNLOAD_SPEED}
      ####G4 P{wait_ms_unload}
      MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
      #MMCS_SERVO_POS_0
      MMCS_SERVOdos_POS_0
      G4 P200

    {% elif AUTOMATIC_COLOR_4|int == 0 %}
      SAVE_VARIABLE VARIABLE=manual_mode VALUE=1
      EXTENDED_RESPOND PREFIX="RETIRE el filamento 4, del EXTRUSOR manualmente por favor." PREFIX_COLOR="warning"
      G4 P8000

    {% else %}
      ;si ocurre un error guarda la variable (unload_warning),la cual se usara en otra macro para mantener la impresion pausada, mientras se soluciona el error.
      SAVE_VARIABLE VARIABLE=unload_warning VALUE=1
      EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="warning" MSG="Error al descargar el color {ACTUAL_COLOR}, verifique el problema y retire el filamento manualmente" COLOR="info"
      
    {% endif %}
      MANUAL_STEPPER STEPPER=mmcs_stepper ENABLE=0 ;;deshabilita el MANUAL_STEPPER

#----------------------------------CARGA DE FILAMENTO-------------------------------------------------------#
[gcode_macro MMCS_AUTO_FILA_LOAD]
gcode:
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="MMCS_AUTO_FILA_LOAD ejecutado...." COLOR="success"

    {% set AUTOMATIC_COLOR_1 = printer["gcode_macro _MMCS_VARS"].automatic_color1|int %}
    {% set AUTOMATIC_COLOR_2 = printer["gcode_macro _MMCS_VARS"].automatic_color2|int %}
    {% set AUTOMATIC_COLOR_3 = printer["gcode_macro _MMCS_VARS"].automatic_color3|int %}
    {% set AUTOMATIC_COLOR_4 = printer["gcode_macro _MMCS_VARS"].automatic_color4|int %}
    {% set NEW_FILAMENT = printer["gcode_macro _MMCS_VARS"].new_filamen_type|string %}
    {% set NEW_COLOR = printer["gcode_macro _MMCS_VARS"].color_nuevo %}
    {% set GEARS_TO_NOZZLE = printer["gcode_macro _MMCS_VARS"].load_gears_to_nozzle|float %}
    {% set LOAD_SPEED = printer["gcode_macro _MMCS_VARS"].load_speed|float %}
    {% set PURGE_EXTRA = printer["gcode_macro _MMCS_VARS"].purge_extra|float %}
    {% set MS_POS1_TO_GEARS = printer["gcode_macro _MMCS_VARS"].ms_initialpos_to_gears|float %}
    {% set MS_L_SPEED = printer["gcode_macro _MMCS_VARS"].ms_load_speed|float %}
    {% set MS_CROSS_GEARS_MOVE = printer["gcode_macro _MMCS_VARS"].ms_cross_gears_move|float %}
    {% set MS_CROSS_GEARS_SPEED = printer["gcode_macro _MMCS_VARS"].ms_cross_speed|float %}
    {% set EX_CROSS_GEARS_MOVE = printer["gcode_macro _MMCS_VARS"].ex_cross_gears_move|float %}
    {% set EX_CROSS_GEARS_SPEED = printer["gcode_macro _MMCS_VARS"].ex_cross_speed|float %}
    {% set FILA_SENSOR_EX1 = printer["gcode_macro _MMCS_VARS"].filament_sensor_extruder1|int %} 

    MANUAL_STEPPER STEPPER=mmcs_stepper ENABLE=1

    #####################################################
    # BLOQUE COLOR 1
    #####################################################
    {% if NEW_COLOR == 1 and AUTOMATIC_COLOR_1|int == 1 %}
        ; COMPROBACION ANTES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="Se detecto un Filamento ya cargado en el extrusor, por favor retirelo para poder cargar el nuevo Filamento." COLOR="warning"
        RETURN
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.

        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT} (Color 1)..." COLOR="success"
        MMCS_SERVOuno_POS_1
        G4 P300
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE=-{MS_POS1_TO_GEARS} SPEED={MS_L_SPEED}
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE=-{MS_CROSS_GEARS_MOVE} SPEED={MS_CROSS_GEARS_SPEED} SYNC=0
        M83
        G92 E0
        G1 E{EX_CROSS_GEARS_MOVE} F{EX_CROSS_GEARS_SPEED}
        MMCS_SERVOuno_POS_0
        G1 E{GEARS_TO_NOZZLE} F{LOAD_SPEED}
        G92 E0
        G4 P1000
        ; COMPROBACION DESPUES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if not printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="El Filamento {NEW_COLOR} no se cargo correctamente, por favor verifique el extrusor y vuelva a cargar el Filamento {NEW_COLOR}." COLOR="warning"
        RETURN
    {% else %}
        EXTENDED_RESPOND PREFIX="OK:" PREFIX_COLOR="success" MSG="Filamento {NEW_COLOR} cargado correctamente." COLOR="success"
        UPDATE_DELAYED_GCODE ID=MMCS_COLOR_CHANGE_V1_RESUME DURATION=2  ;Resume la impresion si el filamento se cargo correcta mente. 
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.

    #####################################################
    # BLOQUE COLOR 2
    #####################################################
    {% elif NEW_COLOR == 2 and AUTOMATIC_COLOR_2|int == 1 %}
        ; COMPROBACION ANTES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="Se detecto un Filamento ya cargado en el extrusor, por favor retirelo para poder cargar el nuevo Filamento." COLOR="warning"
        RETURN
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.

        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT} (Color 2)..." COLOR="success"
        MMCS_SERVOuno_POS_2
        G4 P300
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE={MS_POS1_TO_GEARS} SPEED={MS_L_SPEED}
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE={MS_CROSS_GEARS_MOVE} SPEED={MS_CROSS_GEARS_SPEED} SYNC=0
        M83
        G92 E0
        G1 E{EX_CROSS_GEARS_MOVE} F{EX_CROSS_GEARS_SPEED}
        MMCS_SERVOuno_POS_0
        G1 E{GEARS_TO_NOZZLE} F{LOAD_SPEED}
        G92 E0
        G4 P1000
        ; COMPROBACION DESPUES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if not printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="El Filamento {NEW_COLOR} no se cargo correctamente, por favor verifique el extrusor y vuelva a cargar el Filamento {NEW_COLOR}." COLOR="warning"
        RETURN
    {% else %}
        EXTENDED_RESPOND PREFIX="OK:" PREFIX_COLOR="success" MSG="Filamento {NEW_COLOR} cargado correctamente (sensor2)." COLOR="success"
        UPDATE_DELAYED_GCODE ID=MMCS_COLOR_CHANGE_V1_RESUME DURATION=2  ;Resume la impresion si el filamento se cargo correcta mente.
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.
    #####################################################
    # BLOQUE COLOR 3
    #####################################################
    {% elif NEW_COLOR == 3 and AUTOMATIC_COLOR_3|int == 1 %}
        ; COMPROBACION ANTES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="Se detecto un Filamento ya cargado en el extrusor, por favor retirelo para poder cargar el nuevo Filamento." COLOR="warning"
        RETURN
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.
   
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT} (Color 3)..." COLOR="success"
        MMCS_SERVOdos_POS_3
        G4 P300
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE=-{MS_POS1_TO_GEARS} SPEED={MS_L_SPEED}
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE=-{MS_CROSS_GEARS_MOVE} SPEED={MS_CROSS_GEARS_SPEED} SYNC=0
        M83
        G92 E0
        G1 E{EX_CROSS_GEARS_MOVE} F{EX_CROSS_GEARS_SPEED}
        MMCS_SERVOdos_POS_0
        G1 E{GEARS_TO_NOZZLE} F{LOAD_SPEED}
        G92 E0
        G4 P1000
        ; COMPROBACION DESPUES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if not printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="El Filamento {NEW_COLOR} no se cargo correctamente, por favor verifique el extrusor y vuelva a cargar el Filamento {NEW_COLOR}." COLOR="warning"
        RETURN
    {% else %}
        EXTENDED_RESPOND PREFIX="OK:" PREFIX_COLOR="success" MSG="Filamento {NEW_COLOR} cargado correctamente ." COLOR="success"
        UPDATE_DELAYED_GCODE ID=MMCS_COLOR_CHANGE_V1_RESUME DURATION=2  ;Resume la impresion si el filamento se cargo correcta mente.
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.

    #####################################################
    # BLOQUE COLOR 4
    #####################################################
    {% elif NEW_COLOR == 4 and AUTOMATIC_COLOR_4|int == 1 %}
        ; COMPROBACION ANTES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="Se detecto un Filamento ya cargado en el extrusor, por favor retirelo para poder cargar el nuevo Filamento." COLOR="warning"
        RETURN
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.

        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT} (Color 4)..." COLOR="success"
        MMCS_SERVOdos_POS_4
        G4 P300
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE={MS_POS1_TO_GEARS} SPEED={MS_L_SPEED}
        MANUAL_STEPPER STEPPER=mmcs_stepper SET_POSITION=0
        MANUAL_STEPPER STEPPER=mmcs_stepper MOVE={MS_CROSS_GEARS_MOVE} SPEED={MS_CROSS_GEARS_SPEED} SYNC=0
        M83
        G92 E0
        G1 E{EX_CROSS_GEARS_MOVE} F{EX_CROSS_GEARS_SPEED}
        MMCS_SERVOdos_POS_0
        G1 E{GEARS_TO_NOZZLE} F{LOAD_SPEED}
        G92 E0
        G4 P1000
        ; COMPROBACION DESPUES DE CARGA
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=1 ;Habilita el sensor de filamento del extrusor.
    {% if not printer["filament_switch_sensor filament_sensor1"].filament_detected and FILA_SENSOR_EX1 == 1 %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="info" MSG="El Filamento {NEW_COLOR} no se cargo correctamente, por favor verifique el extrusor y vuelva a cargar el Filamento {NEW_COLOR}." COLOR="warning"
        RETURN
    {% else %}
        EXTENDED_RESPOND PREFIX="OK:" PREFIX_COLOR="success" MSG="Filamento {NEW_COLOR} cargado correctamente." COLOR="success"
        UPDATE_DELAYED_GCODE ID=MMCS_COLOR_CHANGE_V1_RESUME DURATION=2  ;Resume la impresion si el filamento se cargo correcta mente.
    {% endif %}
        SET_FILAMENT_SENSOR SENSOR=filament_sensor1 ENABLE=0 ;Deshabilita el sensor de filamento del extrusor.
    #####################################################
    # COLOR NO RECONOCIDO
    #####################################################
    {% else %}
        SAVE_VARIABLE VARIABLE=load_warning VALUE=1
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="warning" MSG="Filamento no reconocido: {NEW_FILAMENT}" COLOR="error"
    {% endif %}

    MANUAL_STEPPER STEPPER=mmcs_stepper ENABLE=0

#--------------------------------------------------------------------------------------------------------------------------------------------------#

[gcode_macro clean_nozzle_nozhop_mmcs]
gcode:
      M106 S255  #activa el ventilador de capa al 100%, para enfriar el hilo de filamento para poder limpiarlo mejor
      {% set WIPE_COUNT = printer["gcode_macro _MMCS_VARS"].wipe_nozzle_counts|int %}

      SAVE_GCODE_STATE NAME=clean_nozzle2_state

      {% for wipe in range(WIPE_COUNT) %}
      {% for coordinate in [(235, 229),(247, 229)] %} #default (247, 214),(235, 214) el cabezal queda del lado izquierdo.
         G0 X{coordinate[0]} Y{coordinate[1] + 0.25 * wipe} F9000  # F12000  valor default
      {% endfor %}
      {% endfor %}
      G92 E0
      RESTORE_GCODE_STATE NAME=clean_nozzle2_state
#--------------------------------------------------------------------------------------------------------------------------------------------------#

###############################
#------MMCS servos------------#
###############################
;---------------------------------------------------------------------------------------------------------------------
[gcode_macro MMCS_SERVOuno_POS_1]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo_up_angle} #POS 1 angle
    ;G4 P{2000 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_up|int}
    ;SET_SERVO SERVO=mmcs_servo WIDTH=0.0

[gcode_macro MMCS_SERVOuno_POS_0]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo_mid_angle} #POS 0 angle
    ###G4 P{250 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_mid|int}
    SET_SERVO SERVO=mmcs_servo WIDTH=0.0

[gcode_macro MMCS_SERVOuno_POS_2]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo_down_angle} #POS 2 angle
    ;G4 P{2000 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_down|int}
    ;SET_SERVO SERVO=mmcs_servo WIDTH=0.0
;----------------------------------------------------------------------------------------------------------------

;---------------------------------------------------------------------------------------------------------------------
[gcode_macro MMCS_SERVOdos_POS_3]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo2 ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo2_up_angle} #POS 1 angle
    ;G4 P{2000 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_up|int}
    ;SET_SERVO SERVO=mmcs_servo2 WIDTH=0.0

[gcode_macro MMCS_SERVOdos_POS_0]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo2 ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo2_mid_angle} #POS 0 angle
    ###G4 P{250 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_mid|int}
    SET_SERVO SERVO=mmcs_servo2 WIDTH=0.0

[gcode_macro MMCS_SERVOdos_POS_4]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo2 ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo2_down_angle} #POS 2 angle
    ;G4 P{2000 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_down|int}
    ;SET_SERVO SERVO=mmcs_servo2 WIDTH=0.0
;----------------------------------------------------------------------------------------------------------------

#----------------------------------CARGA MANUAL DE FILAMENTO-----------------------------------------------------#
[gcode_macro _CARGA_FILAMENT_MANUAL_1]
gcode:
   M118 CODE06
   #BEEP2
    RESPOND TYPE=command MSG="action:prompt_begin CARGA MANUAL FILAMENTO 1 "
    RESPOND TYPE=command MSG="action:prompt_text Retire manualmente el filamento anterior del Extrusor, luego cargue el filamento 1 y presione continuar"            #mensaje
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    #RESPOND TYPE=command MSG="action:prompt_button filament UNLOAD| _DESCARGA_MANUAL_MOD2|warning"
    RESPOND TYPE=command MSG="action:prompt_button Carga filament|_CARGA_FILA_MANUAL_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Purgar mas|PURGE_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button HAGA CLICK PARA CONTINUAR|MMCS_RESUME|success" ###--PENDIENTE PROBAR MAÑANA, SI NO FUNCIONA REGRESAR A (_CHEK_PAUSE_MOD2).
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _CARGA_FILAMENT_MANUAL_2]
gcode:
   M118 CODE06
   #BEEP2
    RESPOND TYPE=command MSG="action:prompt_begin CARGA MANUAL FILAMENTO 2 "
    RESPOND TYPE=command MSG="action:prompt_text Retire manualmente el filamento anterior del Extrusor, luego cargue el filamento 2 y presione continuar"            #mensaje
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    #RESPOND TYPE=command MSG="action:prompt_button filament UNLOAD| _DESCARGA_MANUAL_MOD2|warning"
    RESPOND TYPE=command MSG="action:prompt_button Carga filament|_CARGA_FILA_MANUAL_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Purgar mas|PURGE_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button HAGA CLICK PARA CONTINUAR|MMCS_RESUME|success" ###--PENDIENTE PROBAR MAÑANA, SI NO FUNCIONA REGRESAR A (_CHEK_PAUSE_MOD2).
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _CARGA_FILAMENT_MANUAL_3]
gcode:
   M118 CODE06
   #BEEP2
    RESPOND TYPE=command MSG="action:prompt_begin CARGA MANUAL FILAMENTO 3 "
    RESPOND TYPE=command MSG="action:prompt_text Retire manualmente el filamento anterior del Extrusor, luego cargue el filamento 3 y presione continuar"            #mensaje
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    #RESPOND TYPE=command MSG="action:prompt_button filament UNLOAD| _DESCARGA_MANUAL_MOD2|warning"
    RESPOND TYPE=command MSG="action:prompt_button Carga filament|_CARGA_FILA_MANUAL_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Purgar mas|PURGE_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button HAGA CLICK PARA CONTINUAR|MMCS_RESUME|success" ###--PENDIENTE PROBAR MAÑANA, SI NO FUNCIONA REGRESAR A (_CHEK_PAUSE_MOD2).
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _CARGA_FILAMENT_MANUAL_4]
gcode:
   M118 CODE06
   #BEEP2
    RESPOND TYPE=command MSG="action:prompt_begin CARGA MANUAL FILAMENTO 4 "
    RESPOND TYPE=command MSG="action:prompt_text Retire manualmente el filamento anterior del Extrusor, luego cargue el filamento 4 y presione continuar"            #mensaje
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    #RESPOND TYPE=command MSG="action:prompt_button filament UNLOAD| _DESCARGA_MANUAL_MOD2|warning"
    RESPOND TYPE=command MSG="action:prompt_button Carga filament|_CARGA_FILA_MANUAL_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Purgar mas|PURGE_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button HAGA CLICK PARA CONTINUAR|MMCS_RESUME|success" ###--PENDIENTE PROBAR MAÑANA, SI NO FUNCIONA REGRESAR A (_CHEK_PAUSE_MOD2).
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"
#---------------------------------------------------------------------------------------------------------#
[gcode_macro MMCS_RESUME]
gcode:
      RESUME

[gcode_macro _CARGA_FILA_MANUAL_MOD] #usado por la macro, CARGA_FILAMENT_MANUAL_MOD].
gcode:
    ;T0
    M83
    G1 E105 F340
    G92 E0

[gcode_macro PURGE_MOD]                                 #purges 20mm and retracts 1mm when finished
variable_purge: 20
gcode:
    {% set E = printer["gcode_macro PURGE_MOD"].purge|float %}
    G1 E{E} F1000
    G92 E0                                          # Reset Extruder
    RETRACT_MOD
    BEEP3

[gcode_macro RETRACT_MOD]
variable_retract: 1
gcode:
    {% set E = printer["gcode_macro RETRACT_MOD"].retract|float %}
    G1 E-{E} F1000
    G92 E0

[gcode_macro _CHEK_PAUSE_MOD2] #usado por la macro, [CARGA_FILAMENT_MANUAL_MOD].
gcode:
    RESPOND type="command" msg="action:prompt_end"
     {% if printer.pause_resume.is_paused %}
       M118 Resuming print
       clean_nozzle_nozhop_mmcs
       EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cleaning Nozzle....." COLOR="success"
       #M118 Cleaning Nozzle...
       RESUME
       M118 CODE8
    {% endif %}

[gcode_macro COUNTDOWN_MOD]
gcode:
    {% set timer = params.TIME|default(10)|int %}
    {% set message = params.MSG|default("Time: ") %}
    # countdown
    {% if timer > 60 %}
        {% for s in range(timer, 60, -10) %}
            M118 {message} {s}s
            G4 P10000                                                           # dwell 10 seconds
        {% endfor %}
        {% set timer = 60 %}
    {% endif %}
    {% if timer > 10 %}
        {% for s in range(timer, 10, -5) %}
            M118 {message} {s}s
            G4 P5000                                                           # dwell 5 seconds
        {% endfor %}
        {% set timer = 10 %}
    {% endif %}
    {% if timer > 0 %}
        {% for s in range(timer, 0, -1) %}
            M118 {message} {s}s
            G4 P1000                                                           # dwell 1 second
        {% endfor %}
    {% endif %}

#-------------test purga para ver la diferencia con o sin el vetilador de capa activado mientras purga, para que el hilo se caiga mas rapido.
#pendiente testear mañana.

[gcode_macro PURGA_TEST_FAN_SI]
gcode:
    {% set purge_length = 30 %}
    {% set purge_speed = 1200 %}
    {% set retract = 3 %}

    M106 S255     #activa fan al 100%.
    G4 P1000      #espera un segundo dando tiempo que el Fan llegue el 100%.
    G92 E0                    ; Reset extrusor
    G1 E{purge_length} F{purge_speed} ; Extruye 30mm
    G1 E-{retract} F{purge_speed}     ; Retrae un poco
    G92 E0                    ; Resetea extrusor
    M106 S0       #apaga el fan de capa.

[gcode_macro PURGA_TEST_FAN_NO]
gcode:
    {% set purge_length = 30 %}
    {% set purge_speed = 1200 %}
    {% set retract = 3 %}

    G92 E0                    ; Reset extrusor
    G1 E{purge_length} F{purge_speed} ; Extruye 30mm
    G1 E-{retract} F{purge_speed}     ; Retrae un poco
    G92 E0                    ; Resetea extrusor

