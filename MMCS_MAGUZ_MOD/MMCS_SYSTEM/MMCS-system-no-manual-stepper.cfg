;´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´;
;Esta es una nueva version del codigo para multicolor, ahora llamada (MMCS_AUTOMATIC_FILAMENT_CHANGE_V1),en esta version ya no se;
;usa el tipo de filamento ejemp,(PLA,PLA1,PLA2,PLA3 y ABS1,ABS2) para el codigo de cambio de color, ahora en su lugar se usa el  ;
;numero de EXTRUSOR actual y siguiente T0,T1,T2,T3, para hacer los cambios de color (filamentos),por eso ahora ya no es necesario;
;modificar el nombre del filamento en OrcaSlicer tal como lo haciamos antes ejmp: cambiarle el nombre (PLA1 para color #1), ahora;
;podemos escoger los filamentos que necesitemos en OrcaSlicer, sin necesidad de modificarles el nombre---------------------------;
;-Ahora las variables ya no se almacenan en (MMCS_AUTOMATIC_FILAMENT_CHANGE_V1), en su logar se almacenaran fuera de ella en ----;
;en variables globales dentro de (_MMCS_VARS).

#------------------------------------------------------Preparar--OrcaSlicer----------------------------------------------------------------------------------------#
# 1) Preparar el slicer en este caso OrcaSlicer, para capturar el tipo de nuevo filamento en cada llamada de cambio de filamento.----------------------------------#
# para esto debemos agregar la siguente linea de ABAJO en la seccion (change_filament_gcode) o (gcode para cambio de filamento)------------------------------------#                                                                                            
# MMCS_AUTOMATIC_FILAMENT_CHANGE_V1 FILAMENT_TYPE=[filament_type] NEW_FILAMENT_TYPE=[filament_type] CURR_EXTRUDER=[current_extruder] NEXT_EXTRUDER=[next_extruder] #
# esa linea de codigo captura los parametros necesarios que seran utilizados por el codigo de "MMCS_AUTOMATIC_FILAMENT_CHANGE_V1", para su correcto funcionamiento-#
# -----------------------------------------------------------------------------------------------------------------------------------------------------------------#

;-------Variables usadas por [MMCS_AUTOMATIC_FILAMENT_CHANGE_V1]---------------------------;
[gcode_macro _MMCS_VARS]
description: Guarda todas las variables usadas por MMCS_AUTOMATIC_FILAMENT_CHANGE_V1 y otros.
variable_inicial_filament_type: ''          #filamento inicial, esta variables es enviada desde (START_PRINT), hasta (inicial_filament_type) .
variable_new_filamen_type: ''
variable_automatic_changfilament: 1         #activa/desactiva, el modo de cambio de filamento automatico defaul "1", cambie a "0" para cambio de filamento manual.
variable_wipe_nozzle_counts: 5
variable_unload_gears_to_initialpos: 80     #distancia desde los engranages del extrusor, hasta la posicion inicial superior. valor anterior 3.40
;;variable_load_initialpos_to_gears: 70     #distacia desde la posicion inicial del filamento, hasta los engranages del ectrusor.
variable_load_initialpos_to_sync_pos: 70    ;carga filamento desde la posicion inicial hasta la posicion SYNC (UBUCADA 20mm antes de los engranages del extrusor), en la parte superior.
variable_load_syncpos_to_gears: 40          ;carga el filamento desde la posicion SYNC, hasta los engranges del extrusor.
variable_load_gears_to_nozzle: 80           #distancia desde los engranages del extrusor, hasta la boquilla.
variable_unload_speed: 3000                 #velocidad para descarga de filamento.
variable_load_speed: 3000                   #velocidad para carga de filamento.
variable_load_speed_sync: 500            
variable_purge_extra: 15 #30                #purga la cantidad establecida, default (20), despues de cargar el filamento. 
variable_filament_sensor_extruder1: 1       #(hace referencia al sensor debajo del extrusor.)
;------colores selector------
variable_automatic_color1: 1            
variable_automatic_color2: 1            
variable_automatic_color3: 0            
variable_automatic_color4: 0            
;------servo-variables-------
variable_mmcs_servo_up_angle: 140       #posicion 1
variable_mmcs_servo_mid_angle: 100      #posicion 0
variable_mmcs_servo_down_angle: 60      #posicion 2
variable_extra_time_servo_up: 0         #tiempo extra solo de ser necesario.
variable_extra_time_servo_down: 0       #tiempo extra solo de ser necesario.
variable_extra_time_servo_mid: 0        #tiempo extra solo de ser necesario.
variable_extrusor_act: 0
variable_extrusor_sig: 0
variable_color_act: 0                   #esta variable contiene el valor ya convertido en la seccion (codigos para la conversion de valores).
variable_color_nuevo: 0                 #esta variable contiene el valor ya convertido en la seccion (codigos para la conversion de valores).

;;variable_saved_speed_fact: 0.0
gcode:  
;------------------END-VARIABLES--------------------------------;

[gcode_macro MMCS_AUTOMATIC_FILAMENT_CHANGE_V1]
description:Esta macro es la encargada de gestionar los cambios de color (filamentos), automaticamente usando el sistema MMCS.
variable_anterior_filamen_type: ''     #al usar esta variable dentro la misma macro,mostrara el valor guardado anteriormente, en este caso mostrara el tipo de filamento anterior
gcode:  
    SAVE_GCODE_STATE NAME=MMCS_AUTOMATIC_FILAMENT_CHANGE_V1_STATE
    
    ;-----------definicion---------------------
    {% set AUTO_FILAMENT_CHANG = printer["gcode_macro _MMCS_VARS"].automatic_changfilament|int %}
    {% set NEW_FILAMENT_TYPE = params.NEW_FILAMENT_TYPE|default('none')|string %} #obtiene el tipo de filamento desde OrcaSlicer, en la seccion GCODE para cambio de filamento, el cual se actualizara cada vez que se ejecute un cambio de color.
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=new_filamen_type VALUE='"{NEW_FILAMENT_TYPE}"'
    SET_GCODE_VARIABLE MACRO=MMCS_AUTOMATIC_FILAMENT_CHANGE_V1 VARIABLE=anterior_filamen_type VALUE='"{NEW_FILAMENT_TYPE}"' ;solo para uso interno de la macro (MMCS_AUTOMATIC_FILAMENT_CHANGE_V1), guarda NEW_FILAMENT_TYPE en la variable, (anterior_filamen_type) esto mostrara el filamento anterior.
    ;___  test-captura extrusor-actual-y siguiente____
    {% set extrusor_actual = params.CURR_EXTRUDER|int %} ;el (current_extruder) o extrusor actual quedaria como el extrusor anterior, ya que fue el ultimo que se uso.
    {% set extrusor_siguiente = params.NEXT_EXTRUDER|int %}     ;next_extruder seria el nuevo extrusor a usar.
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=extrusor_act VALUE={extrusor_actual}
    SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=extrusor_sig VALUE={extrusor_siguiente}

;----captura la el factor de velocidad actual que usa mainsail, para restaurarlo al terminar el cambio de color 
#   {% set current_speed = printer.gcode_move.speed_factor %}
#   SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=saved_speed_fact VALUE={printer.gcode_move.speed_factor}
#   M118 la velosidad guardada es: {current_speed}
    
;################################-codigos para la conversion de valores -########################################;
;-este codigo toma el numero de extrusor pasado como parametro desde OrcaSlicer, y lo convierte a un numero mayor;
;-ejemp:                                                                                                         ;
;-de T0, toma el "0" y lo eleva a "1"| ahora T0 seria = a 1 que a su vez sera =color #1                          ;
;-de T1, toma el "1" y lo eleva a "2"| ahora T1 seria = a 2 que a su vez sera =color #2                          ;
;-de T2, toma el "2" y lo eleva a "3"| ahora T2 seria = a 3 que a su vez sera =color #3                          ;
;-de T3, toma el "3" y lo eleva a "4"| ahora T3 seria = a 4 que a su vez sera =color #4                          ;
;-esto hara mas facil el codigo para carga y descarga ya que no se usara 0,1,2,3,4 en el codigo para comprobacion;
;-como en este caso: {% if ACTUAL_COLOR == 0 %} donde se usa "0" para comprobar el color 1 equivalente a "T0",   ;
;-ahora en cambio podemos usat "1" derectamente para comprobar el color #1 {% if ACTUAL_COLOR == 1 %}            ;  
;-quedando asi los colores 1,2,3,4 equivalentes a 4 colores y no 0,1,2,3.                                        ;
    
    {% if 'CURR_EXTRUDER' in params %} ;toma el valor de (CURR_EXTRUDER) pasado como parametro desde OrcaSlicer
        # Convertimos el valor del parámetro a un número entero
        {% set curr_extruder = params.CURR_EXTRUDER|int %}  
        # Incrementamos el valor en 1
        {% set curr_extruder_convr = curr_extruder + 1 %}
        SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=color_act VALUE={curr_extruder_convr} ;Guarda el numero de extrusor ya convertido  en la variable (color_act).
        # Imprimimos el resultado en la consola de Klipper
        M118 El color actual es: T{curr_extruder} convertido a: {curr_extruder_convr}
    {% else %}
        M118 ERROR: La macro de conversion requiere el parámetro CURR_EXTRUDER.
    {% endif %}

    {% if 'NEXT_EXTRUDER' in params %}
        # Convertimos el valor del parámetro a un número entero
        {% set nxt_extruder = params.NEXT_EXTRUDER|int %}
        # Incrementamos el valor en 1
        {% set nxt_extruder_convr = nxt_extruder + 1 %}
        SET_GCODE_VARIABLE MACRO=_MMCS_VARS VARIABLE=color_nuevo VALUE={nxt_extruder_convr} ;Guarda el numero de extrusor ya convertido  en la variable (color_nuevo).
        # Imprimimos el resultado en la consola de Klipper
        M118 El nuevo color es: T{nxt_extruder} convertido a: {nxt_extruder_convr}
    {% else %}
        M118 ERROR: La macro de conversion requiere el parámetro NEXT_EXTRUDER.
    {% endif %}
    
;mensajes de acciones......
    M118 Cambiando de extrusor T{extrusor_actual} → T{extrusor_siguiente}
    EXTENDED_RESPOND PREFIX=":" PREFIX_COLOR="info" MSG="MMCS_AUTOMATIC_FILAMENT_CHANGE_V1 Ejecutado..." COLOR="success"
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Changing filament...." COLOR="success"
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Filamento anterior:{anterior_filamen_type} en T{extrusor_actual}" COLOR="success"             #muestra un mensaje con el filamento anterior.
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cambiando a nuevo filamento:{NEW_FILAMENT_TYPE} en T{extrusor_siguiente}" COLOR="success"   #muestra un mensaje con el filamento actual.
#-------------------------VERIFICA SI LA IMPRESORA ESTA PAUSADA---------------------------------------------#
    {% if printer.pause_resume.is_paused %}
      EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG=" Print Already paused.." COLOR="success"  #agregado nuevo15/12
    {% else %}
      {% if printer.toolhead.homed_axes != "xyz" %}
          M118 Homing
          G28                                                            # home if not homed
      {% else %}
          EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Pausing print...." COLOR="success"
          PAUSE
      {% endif %}
    {% endif %}
    SET_IDLE_TIMEOUT TIMEOUT=7200
    MMCS_AUTO_FILA_UNLOAD
    G4 P3000               #crea una pausa entre UNLOAD_MOD y LOAD_MOD #NUEVO 23/11
    MMCS_AUTO_FILA_LOAD
    ##RESTORE_SPEED_FACTOR ##TESTEAR PENDIENTE 16-8
    RESTORE_GCODE_STATE NAME=MMCS_AUTOMATIC_FILAMENT_CHANGE_V1_STATE
    UPDATE_DELAYED_GCODE ID=MMCS_AUTOMATIC_FILAMENT_CHANGE_V1_RESUME DURATION=2 ##RESUME automaticamente 2 segundos despues.
    
#este codigo es usado pra que la impresion se resuma automaticamente, ya que usar RESUME directamente desde la macro para cambio de filamento no funciona.
[delayed_gcode MMCS_AUTOMATIC_FILAMENT_CHANGE_V1_RESUME] 
gcode:
    {% if printer.pause_resume.is_paused %}
        M118 Resuming print
        clean_nozzle_nozhop_mmcs ;limpia la boquilla
        RESUME
        RESTORE_SPEED_FACTOR
    {% endif %}     
#----------------------------------DESCARGA DE FILAMENTO-------------------------------------------------------#
    
[gcode_macro MMCS_AUTO_FILA_UNLOAD]
description: Macro encargada de gestionar la descarga y el moldeado de punta, dependiendo el tipo de filamento, para luejo ejecutarla en MMCS_UNLOAD.
gcode:
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="MMCS_AUTO_FILA_UNLOAD ejecurado...." COLOR="success"
    {% set timer = params.T|default(6)|float %}
    {% set INICIAL_FILAMENT_TYPE = printer["gcode_macro _MMCS_VARS"].inicial_filament_type|string %}   #toma el tipo de filamento inicial desde (MMCS_AUTOMATIC_FILAMENT_CHANGE_V1), el cual lo recibe desde START_PRINT.
    ;Este codigo aplica el TIP FORMING dependiendo del tipo de material o (filamento).
    {% set material_type = printer["gcode_macro _MMCS_VARS"].inicial_filament_type ;Este codigo omite los numeros y toma solo el texto ejemp; de PLA1, toma solo PLA y omite el numero 1.
         | replace('1','') 
         | replace('2','') 
         | replace('3','') 
         | replace('4','') %}
         
    {% if material_type == 'PLA' %}
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Moldeando punta de filamento:{material_type}" COLOR="success"
        LOW_TEMP_CHECK_PLA # NUEVO
        ;MMCS_FORM_TIP_STANDALONE
        ERCF_FORM_TIP_STANDALONE
        G4 P1000
        MMCS_UNLOAD
    {% elif material_type == 'ABS' or material_type == 'ASA' %}
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Moldeando punta de filamento:{material_type}" COLOR="success"
        LOW_TEMP_CHECK_ABS #NUEVO
        ;MMCS_FORM_TIP_STANDALONE
        ERCF_FORM_TIP_STANDALONE
        G4 P1000
        MMCS_UNLOAD
    {% elif material_type == 'PETG' %}
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Moldeando punta de filamento:{material_type}" COLOR="success"
        LOW_TEMP_CHECK_ABS           #Pendiente configurar parametros para PETG.
        ;MMCS_FORM_TIP_STANDALONE
        ERCF_FORM_TIP_STANDALONE     #Pendiente configurar parametros para PETG.
        G4 P1000
        MMCS_UNLOAD  
    {% else %}
        M118 Material no reconocido NO  se pudo Descargar
    {% endif %}
    
[gcode_macro MMCS_UNLOAD]
description: Esta macro descarga el filamento previamente gestionado por (MMCS_AUTO_FILA_UNLOAD).
gcode:
    {% set AUTOMATIC_COLOR_1 = printer["gcode_macro _MMCS_VARS"].automatic_color1|int %}
    {% set AUTOMATIC_COLOR_2 = printer["gcode_macro _MMCS_VARS"].automatic_color2|int %}
    {% set AUTOMATIC_COLOR_3 = printer["gcode_macro _MMCS_VARS"].automatic_color3|int %}
    {% set AUTOMATIC_COLOR_4 = printer["gcode_macro _MMCS_VARS"].automatic_color4|int %}
    {% set UNLOAD_SPEED = printer["gcode_macro _MMCS_VARS"].unload_speed|float %}
    {% set GEARS_INITIALPOS = printer["gcode_macro _MMCS_VARS"].unload_gears_to_initialpos|float %}
    #----------------unload-front-extruder-gears-to-PTFF-tube-initinal-position-----------
    {% set ACTUAL_COLOR = printer["gcode_macro _MMCS_VARS"].color_act|int %} ;Usa la variable (color_act), la cual tiene el valor previamente convertido, para obtener el numero de color.
    
    {% if ACTUAL_COLOR == 1 and AUTOMATIC_COLOR_1|int == 1 %} ;COLOR #1
      TX1
      G4 P200           
      ; --- Abrir servo ---
      MMCS_SERVO_POS_1
      G4 P400
      ; --- Retracción ---
      M83
      G92 E0
      G1 E-{GEARS_INITIALPOS} F{UNLOAD_SPEED}
      G4 P300
      ; --- Cerrar servo ---
      G92 E0
      MMCS_SERVO_POS_0
      G4 P400

    {% elif ACTUAL_COLOR == 2 and AUTOMATIC_COLOR_2|int == 1 %} ;COLOR #2
      TX2
      G4 P200 
      ; --- Abrir servo ---
      MMCS_SERVO_POS_2
      G4 P400
      ; --- Retracción ---
      M83
      G92 E0
      G1 E-{GEARS_INITIALPOS} F{UNLOAD_SPEED}
      G4 P300
      ; --- Cerrar servo ---
      G92 E0
      MMCS_SERVO_POS_0
      G4 P400

    {% elif ACTUAL_COLOR == 3 and AUTOMATIC_COLOR_3|int == 1 %} ;COLOR #3
      TX3
      G4 P200 
      ; --- Abrir servo ---
      MMCS_SERVO_POS_3
      G4 P400
      ; --- Retracción ---
      M83
      G92 E0
      G1 E-{GEARS_INITIALPOS} F{UNLOAD_SPEED}
      G4 P300
      ; --- Cerrar servo ---
      G92 E0
      MMCS_SERVO_POS_0
      G4 P400

    {% elif AUTOMATIC_COLOR_3|int == 0 %} #codigo para descargar manual
      EXTENDED_RESPOND PREFIX="RETIRE el filamento 3, del EXTRUSOR manualmente por favor." PREFIX_COLOR="warning"  #NUEVO 23/11
      G4 P8000
        
    {% elif ACTUAL_COLOR == 4 and AUTOMATIC_COLOR_4|int == 1 %} ;COLOR #4
      TX4
      G4 P200 
      ; --- Abrir servo ---
      MMCS_SERVO_POS_4
      G4 P400
      ; --- Retracción ---
      M83
      G92 E0
      G1 E-{GEARS_INITIALPOS} F{UNLOAD_SPEED}
      G4 P300
      ; --- Cerrar servo ---
      G92 E0
      MMCS_SERVO_POS_0
      G4 P400        
      
    {% elif AUTOMATIC_COLOR_4|int == 0 %}  #codigo para descargar manual
      EXTENDED_RESPOND PREFIX="RETIRE el filamento 4, del EXTRUSOR manualmente por favor." PREFIX_COLOR="warning"  #NUEVO 23/11
      G4 P8000   
    {% else %}
         EXTENDED_RESPOND PREFIX=":ERROR al veificar ANTERIOR_EXTRUDER. " PREFIX_COLOR="warning"        
    {% endif %} 

#----------------------------------CARGA DE FILAMENTO-------------------------------------------------------#    
[gcode_macro MMCS_AUTO_FILA_LOAD]
variable_anterior_filamen: ''
gcode:
    EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="MMCS_AUTO_FILA_LOAD ejecurado...." COLOR="success"
    {% set AUTOMATIC_COLOR_1 = printer["gcode_macro _MMCS_VARS"].automatic_color1|int %}
    {% set AUTOMATIC_COLOR_2 = printer["gcode_macro _MMCS_VARS"].automatic_color2|int %}
    {% set AUTOMATIC_COLOR_3 = printer["gcode_macro _MMCS_VARS"].automatic_color3|int %}
    {% set AUTOMATIC_COLOR_4 = printer["gcode_macro _MMCS_VARS"].automatic_color4|int %}
    #--------------load-front-initinal-position-PTFF-tube-to-extruder-gears-------
    {% set INITALPOS_TO_SYNC_POS = printer["gcode_macro _MMCS_VARS"].load_initialpos_to_sync_pos|float %}
    {% set SYNCPOS_TO_GEARS = printer["gcode_macro _MMCS_VARS"].load_syncpos_to_gears|float %}
    {% set LOAD_SYNC_SPEED = printer["gcode_macro _MMCS_VARS"].load_speed_sync|float %}
    {% set GEARS_TO_NOZZLE = printer["gcode_macro _MMCS_VARS"].load_gears_to_nozzle|float %}
    {% set LOAD_SPEED = printer["gcode_macro _MMCS_VARS"].load_speed|float %}
    {% set PURGE_EXTRA = printer["gcode_macro _MMCS_VARS"].purge_extra|float %}
    {% set NEW_FILAMENT = printer["gcode_macro _MMCS_VARS"].new_filamen_type|string %} 
    SET_GCODE_VARIABLE MACRO=MMCS_AUTO_FILA_LOAD VARIABLE=anterior_filamen VALUE='"{NEW_FILAMENT}"' ;solo para uso dentro de la macro (MMCS_AUTO_FILA_LOAD), esto mostrara el filamento cargado anteriormente.

    ;SAVE_GCODE_STATE NAME=AUTO_FILA_LOAD                   #agregado nuevo 1-8-25

    {% set NEW_COLOR = printer["gcode_macro _MMCS_VARS"].color_nuevo %} ;Usa la variable (color_nuevo), la cual tiene el valor previamente convertido, para obtener el numero del nuevo color.
    #----------------------VERIFICACION-PLA----------------------------- 
    {% if NEW_COLOR == 1 and AUTOMATIC_COLOR_1|int == 1 %}  ;COLOR #1
      EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT}..." COLOR="success"
      TX1
      G4 P200                        ; Pausa breve para estabilizar el cambio de herramienta
      ; --- Posicionar servo para carga ---
      MMCS_SERVO_POS_1
      G4 P400                        ; Tiempo suficiente para que el servo llegue a posición
      ; --- Preparar extrusión ---
      M83
      G92 E0
      G1 E{INITALPOS_TO_SYNC_POS} F{LOAD_SPEED}
      ; --- Sincronizar engranajes ---
      ENABLE_EXT_SYNC
      G1 E{SYNCPOS_TO_GEARS} F{LOAD_SYNC_SPEED}
; desactivada G4 P300                        ; Pequeña espera para evitar saltos al cerrar servo
      ; --- Cerrar servo ---
      MMCS_SERVO_POS_0
; desactivada  G4 P400                        ; Esperar que servo bloquee
      ; --- Volver al extrusor principal ---
      T0
; desactivada     G4 P200                        ; Pausa para evitar arranque en vacío
      ; --- Cargar hasta la boquilla ---
      G1 E{GEARS_TO_NOZZLE} F360
; desactivada      G4 P300                        ; Espera antes de purgar
      ; --- Purgado final ---
      G1 E{PURGE_EXTRA} F360
      ; --- Reset extrusión ---
      G92 E0
      FILAMENT_SENSOR_EXTRUDER_FILAMENT_STATUS_1
      RESTORE_SPEED_FACTOR
      ########MMCS_RESUME

    {% elif NEW_COLOR == 2 and AUTOMATIC_COLOR_1|int == 1 %}  ;COLOR #2
      EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT}..." COLOR="success"
      TX2
      G4 P200                        ; Pausa breve para estabilizar el cambio de herramienta
      ; --- Posicionar servo para carga ---
      MMCS_SERVO_POS_2
      G4 P400                        ; Tiempo suficiente para que el servo llegue a posición
      ; --- Preparar extrusión ---
      M83
      G92 E0
      G1 E{INITALPOS_TO_SYNC_POS} F{LOAD_SPEED}
      ; --- Sincronizar engranajes ---
      ENABLE_EXT_SYNC
      G1 E{SYNCPOS_TO_GEARS} F{LOAD_SYNC_SPEED}
; desactivadaG4 P300                        ; Pequeña espera para evitar saltos al cerrar servo
      ; --- Cerrar servo ---
      MMCS_SERVO_POS_0
; desactivada   G4 P400                        ; Esperar que servo bloquee
      ; --- Volver al extrusor principal ---
      T0
; desactivada     G4 P200                        ; Pausa para evitar arranque en vacío
      ; --- Cargar hasta la boquilla ---
      G1 E{GEARS_TO_NOZZLE} F360
; desactivada     G4 P300                        ; Espera antes de purgar
      ; --- Purgado final ---
      G1 E{PURGE_EXTRA} F360
      ; --- Reset extrusión ---
      G92 E0
      FILAMENT_SENSOR_EXTRUDER_FILAMENT_STATUS_1
      RESTORE_SPEED_FACTOR
      ######MMCS_RESUME

    {% elif NEW_COLOR == 3 and AUTOMATIC_COLOR_3|int == 1 %}    ;COLOR #3
      EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT}..." COLOR="success"
      TX3
      G4 P200                        ; Pausa breve para estabilizar el cambio de herramienta
      ; --- Posicionar servo para carga ---
      MMCS_SERVO_POS_3
      G4 P400                        ; Tiempo suficiente para que el servo llegue a posición
      ; --- Preparar extrusión ---
      M83
      G92 E0
      G1 E{INITALPOS_TO_SYNC_POS} F{LOAD_SPEED}
      ; --- Sincronizar engranajes ---
      ENABLE_EXT_SYNC
      G1 E{SYNCPOS_TO_GEARS} F{LOAD_SYNC_SPEED}
; desactivada      G4 P300                        ; Pequeña espera para evitar saltos al cerrar servo
      ; --- Cerrar servo ---
      MMCS_SERVO_POS_0
; desactivada   G4 P400                        ; Esperar que servo bloquee
      ; --- Volver al extrusor principal ---
      T0
; desactivada    G4 P200                        ; Pausa para evitar arranque en vacío
      ; --- Cargar hasta la boquilla ---
      G1 E{GEARS_TO_NOZZLE} F360
; desactivada     G4 P300                        ; Espera antes de purgar
      ; --- Purgado final ---
      G1 E{PURGE_EXTRA} F360
      ; --- Reset extrusión ---
      G92 E0
      FILAMENT_SENSOR_EXTRUDER_FILAMENT_STATUS_1
      ########MMCS_RESUME

    {% elif NEW_COLOR == 3 and AUTOMATIC_COLOR_3|int == 0 %} ;COLOR #3  #usado para cargar el filamento manual (NO AUTOMATICO)
      SAVE_VARIABLE VARIABLE=activeextruder VALUE=3 
      EXTENDED_RESPOND PREFIX="INSERTE el filamento {NEW_FILAMENT} manualmente por favor." PREFIX_COLOR="warning"
      EXTENDED_RESPOND PREFIX="CAMBIO DE FILAMENTO MANUAL:Inserte el filamento {NEW_FILAMENT} manualmente por favor." PREFIX_COLOR="warning"              
      T0 #AGREGADO ANOCHE PENDIENTE PROBAR
      _CARGA_FILAMENT_MANUAL_3

   {% elif NEW_COLOR == 4 and AUTOMATIC_COLOR_4|int == 1 %}
      EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cargando nuevo filamento {NEW_FILAMENT}..." COLOR="success"
      TX4
      G4 P200                        ; Pausa breve para estabilizar el cambio de herramienta
      ; --- Posicionar servo para carga ---
      MMCS_SERVO_POS_4
      G4 P400                        ; Tiempo suficiente para que el servo llegue a posición
      ; --- Preparar extrusión ---
      M83
      G92 E0
      G1 E{INITALPOS_TO_SYNC_POS} F{LOAD_SPEED}
      ; --- Sincronizar engranajes ---
      ENABLE_EXT_SYNC
      G1 E{SYNCPOS_TO_GEARS} F{LOAD_SYNC_SPEED}
; desactivada      G4 P300                        ; Pequeña espera para evitar saltos al cerrar servo
      ; --- Cerrar servo ---
      MMCS_SERVO_POS_0
; desactivada   G4 P400                        ; Esperar que servo bloquee
      ; --- Volver al extrusor principal ---
      T0
; desactivada    G4 P200                        ; Pausa para evitar arranque en vacío
      ; --- Cargar hasta la boquilla ---
      G1 E{GEARS_TO_NOZZLE} F360
; desactivada     G4 P300                        ; Espera antes de purgar
      ; --- Purgado final ---
      G1 E{PURGE_EXTRA} F360
      ; --- Reset extrusión ---
      G92 E0
      FILAMENT_SENSOR_EXTRUDER_FILAMENT_STATUS_1
      ########MMCS_RESUME
    {% elif NEW_COLOR == 4 and AUTOMATIC_COLOR_4|int == 0 %} #usado para cargar el filamento manual (NO AUTOMATICO) 
      SAVE_VARIABLE VARIABLE=activeextruder VALUE=4
      EXTENDED_RESPOND PREFIX="INSERTE el filamento {NEW_FILAMENT} manualmente por favor." PREFIX_COLOR="warning"
      EXTENDED_RESPOND PREFIX="CAMBIO DE FILAMENTO MANUAL:Inserte el filamento {NEW_FILAMENT} manualmente por favor." PREFIX_COLOR="warning"
      T0
      _CARGA_FILAMENT_MANUAL_4
      {% else %}
       EXTENDED_RESPOND PREFIX="WARNING: Filamento no reconocido" PREFIX_COLOR="warning" MSG=":Por favor Verifique el TIPO de filamento.{NEW_FILAMENT}" COLOR="error"
     {% endif %}

#-------------------INICIO-DE-GCODE PARA RESUMIR LA IMPRESION---------------------------------------#NUEVO 23/11
[gcode_macro MMCS_RESUME]
gcode:
    
    {% set SENSOR_FILAMENT_EXTRUDER = printer["gcode_macro _MMCS_VARS"].filament_sensor_extruder1|int %}
    {% set AUTO_FILAMENT_CHANG = printer["gcode_macro _MMCS_VARS"].automatic_changfilament|int %}
    
    {% if SENSOR_FILAMENT_EXTRUDER|int == 1 and printer["gcode_button FILAMENT_SENSOR_EXTRUDER_1"].state == "PRESSED" %}
        ACTIVE_MMCS_RESUME_BUTTOM
        clean_nozzle_nozhop_mmcs
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cleaning Nozzle....." COLOR="success"
        
    {% elif SENSOR_FILAMENT_EXTRUDER|int == 1 and printer["gcode_button FILAMENT_SENSOR_EXTRUDER_1"].state == "RELEASED" %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="warning" MSG="SENSOR [OFF]" COLOR="error"
        EXTENDED_RESPOND PREFIX="RESUMING-PRINT ERROR:" PREFIX_COLOR="warning" MSG="No se pudo resumir la impresion, posiblemente el filamento no se haya cargado correctamente, verifique la falla y continue la impresion manualmente" COLOR="error"
   
    {% elif AUTO_FILAMENT_CHANG|int == 1 and SENSOR_FILAMENT_EXTRUDER|int == 0 %}
        ACTIVE_MMCS_RESUME_BUTTOM
        clean_nozzle_nozhop_mmcs
        EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cleaning Nozzle....." COLOR="success"
    
    {% elif AUTO_FILAMENT_CHANG|int == 0 %}
        _CARGA_FILAMENT_MANUAL_MOD
    {% else %}
        EXTENDED_RESPOND PREFIX="WARNING:" PREFIX_COLOR="warning" MSG="Hubo un error en la seccion GCODE PARA RESUMIR LA IMPRESION." COLOR="error"
    {% endif %}
    
#-----Se mueve a la derecha para activar el Boton fisico para resumir la impresion.  
[gcode_macro ACTIVE_MMCS_RESUME_BUTTOM]  #movido de posicion 13/5/25 pendiente
gcode:
      BEEP2  #2 PITIDOS
      #INICIO--------Mueve 1 milimetros,a la derecha para activar el boton de RESUME---- (PENDIENTE TESTEAR CON EL BOTON FISICO)
      G91
      G1 X1 F200
      G90
#--------------------------------------------------------------------------------------------------------------------------------------------------#
[gcode_macro clean_nozzle_nozhop_mmcs]
gcode:
      M106 S255  #activa el ventilador de capa al 100%, para enfriar el hilo de filamento para poder limpiarlo mejor
      {% set WIPE_COUNT = printer["gcode_macro _MMCS_VARS"].wipe_nozzle_counts|int %}
  
      SAVE_GCODE_STATE NAME=clean_nozzle2_state
  
      {% for wipe in range(WIPE_COUNT) %}
      {% for coordinate in [(235, 229),(247, 229)] %} #default (247, 214),(235, 214) el cabezal queda del lado izquierdo.
         G0 X{coordinate[0]} Y{coordinate[1] + 0.25 * wipe} F9000  # F12000  valor default
      {% endfor %}
      {% endfor %}
      G92 E0
      RESTORE_GCODE_STATE NAME=clean_nozzle2_state
#--------------------------------------------------------------------------------------------------------------------------------------------------#

###############################
#------MMCS servos------------#
###############################
;---------------------------------------------------------------------------------------------------------------------
[gcode_macro MMCS_SERVO_POS_1]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo_up_angle} #POS 1 angle
    ;G4 P{2000 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_up|int}
    ;SET_SERVO SERVO=mmcs_servo WIDTH=0.0

[gcode_macro MMCS_SERVO_POS_0]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo_mid_angle} #POS 0 angle
    G4 P{250 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_mid|int}
    SET_SERVO SERVO=mmcs_servo WIDTH=0.0

[gcode_macro MMCS_SERVO_POS_2]
description: Disengage the ERCF gear
gcode:
    SET_SERVO SERVO=mmcs_servo ANGLE={printer["gcode_macro _MMCS_VARS"].mmcs_servo_down_angle} #POS 2 angle
    ;G4 P{2000 + printer["gcode_macro _MMCS_VARS"].extra_time_servo_down|int}
    ;SET_SERVO SERVO=mmcs_servo WIDTH=0.0   

;----------------------------------------------------------------------------------------------------------------    
    

#----------------------------------CARGA MANUAL DE FILAMENTO-----------------------------------------------------#
[gcode_macro _CARGA_FILAMENT_MANUAL_3]
gcode:
   M118 CODE06
   #BEEP2
    RESPOND TYPE=command MSG="action:prompt_begin CARGA MANUAL FILAMENTO 3 "
    RESPOND TYPE=command MSG="action:prompt_text Retire manualmente el filamento anterior del Extrusor, luego cargue el filamento 3 y presione continuar"            #mensaje
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    #RESPOND TYPE=command MSG="action:prompt_button filament UNLOAD| _DESCARGA_MANUAL_MOD2|warning"
    RESPOND TYPE=command MSG="action:prompt_button Carga filament|_CARGA_FILA_MANUAL_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Purgar mas|PURGE_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button HAGA CLICK PARA CONTINUAR|MMCS_RESUME|success" ###--PENDIENTE PROBAR MAÑANA, SI NO FUNCIONA REGRESAR A (_CHEK_PAUSE_MOD2).
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _CARGA_FILAMENT_MANUAL_4]
gcode:
   M118 CODE06
   #BEEP2
    RESPOND TYPE=command MSG="action:prompt_begin CARGA MANUAL FILAMENTO 4 "
    RESPOND TYPE=command MSG="action:prompt_text Retire manualmente el filamento anterior del Extrusor, luego cargue el filamento 4 y presione continuar"            #mensaje
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    #RESPOND TYPE=command MSG="action:prompt_button filament UNLOAD| _DESCARGA_MANUAL_MOD2|warning"
    RESPOND TYPE=command MSG="action:prompt_button Carga filament|_CARGA_FILA_MANUAL_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Purgar mas|PURGE_MOD|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button HAGA CLICK PARA CONTINUAR|MMCS_RESUME|success" ###--PENDIENTE PROBAR MAÑANA, SI NO FUNCIONA REGRESAR A (_CHEK_PAUSE_MOD2).
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"
#---------------------------------------------------------------------------------------------------------#

[gcode_macro _CARGA_FILA_MANUAL_MOD] #usado por la macro, CARGA_FILAMENT_MANUAL_MOD].
gcode:
    T0
    M83
    G1 E105 F340
    G92 E0

[gcode_macro PURGE_MOD]                                 #purges 20mm and retracts 1mm when finished
variable_purge: 20
gcode:
    {% set E = printer["gcode_macro PURGE_MOD"].purge|float %}
    G1 E{E} F1000
    G92 E0                                          # Reset Extruder
    RETRACT_MOD
    BEEP3

[gcode_macro RETRACT_MOD]
variable_retract: 1
gcode:
    {% set E = printer["gcode_macro RETRACT_MOD"].retract|float %}
    G1 E-{E} F1000 
    G92 E0     

[gcode_macro _CHEK_PAUSE_MOD2] #usado por la macro, [CARGA_FILAMENT_MANUAL_MOD].
gcode:
    RESPOND type="command" msg="action:prompt_end"
     {% if printer.pause_resume.is_paused %}
       M118 Resuming print
       clean_nozzle_nozhop_mmcs
       EXTENDED_RESPOND PREFIX="AVISO:" PREFIX_COLOR="info" MSG="Cleaning Nozzle....." COLOR="success"
       #M118 Cleaning Nozzle...
       RESUME
       M118 CODE8
    {% endif %}
    
[gcode_macro COUNTDOWN_MOD]
gcode:
    {% set timer = params.TIME|default(10)|int %}
    {% set message = params.MSG|default("Time: ") %}
    # countdown
    {% if timer > 60 %}
        {% for s in range(timer, 60, -10) %}
            M118 {message} {s}s
            G4 P10000                                                           # dwell 10 seconds
        {% endfor %}
        {% set timer = 60 %}
    {% endif %}
    {% if timer > 10 %}
        {% for s in range(timer, 10, -5) %}
            M118 {message} {s}s
            G4 P5000                                                           # dwell 5 seconds
        {% endfor %}
        {% set timer = 10 %}
    {% endif %}
    {% if timer > 0 %}
        {% for s in range(timer, 0, -1) %}
            M118 {message} {s}s
            G4 P1000                                                           # dwell 1 second
        {% endfor %}
    {% endif %}
